import{ay as Ie,r as w,c as $,h as Ce,z as E,A as h,B as n,R as l,J as a,O as p,al as c,u as S,K as Ve,ar as be,I as T,P as _,W as R,a4 as Ae,L as ee,Q as le,a6 as te}from"./vendor-BleAlWPf.js";import{A as ke,r as De,j as se,E as m,z as F}from"./element-C3fiOSfn.js";import{r as x,_ as ze,a as Ee,D as Se}from"./index-B_XiphaB.js";import"./charts-TxDtCNV3.js";const P={getUsers(i={}){return console.log("=== API调用: 获取用户列表 ==="),console.log("请求参数:",i),x.get("/api/v1/users",{params:i})},getUserById(i){return console.log("=== API调用: 获取用户详情 ==="),console.log("用户ID:",i),x.get(`/api/v1/users/${i}`)},createUser(i){return console.log("=== API调用: 创建用户 ==="),console.log("用户数据:",i),x.post("/api/v1/users",i)},updateUser(i,g){return console.log("=== API调用: 更新用户 ==="),console.log("用户ID:",i),console.log("更新数据:",g),x.put(`/api/v1/users/${i}`,g)},deleteUser(i){return console.log("=== API调用: 删除用户 ==="),console.log("用户ID:",i),x.post(`/api/v1/users/${i}/delete`)}},Te=Ie("user",()=>{const i=w([]),g=w(null),u=w(!1),o=w(null),A=$(()=>i.value.length),C=$(()=>i.value.filter(d=>d.status==="ACTIVE").length),k=$(()=>i.value.filter(d=>d.status==="INACTIVE").length),U=async(d={})=>{u.value=!0,o.value=null,console.log("=== 用户Store: 开始获取用户列表 ==="),console.log("请求参数:",d);try{const r=await P.getUsers(d);return console.log("用户API响应:",r),console.log("响应中的用户数组:",r.users),console.log("用户数组长度:",r.users?.length),i.value=r.users||[],console.log("设置用户列表:",i.value.length,"个用户"),console.log("最终用户列表:",i.value),r}catch(r){throw console.error("获取用户列表失败:",r),o.value=r.message,r}finally{u.value=!1}};return{users:i,selectedUser:g,loading:u,error:o,userCount:A,activeUserCount:C,inactiveUserCount:k,fetchUsers:U,fetchUserById:async d=>{u.value=!0,o.value=null,console.log("=== 用户Store: 开始获取用户详情 ==="),console.log("用户ID:",d);try{const r=await P.getUserById(d);return console.log("用户详情API响应:",r),g.value=r,r}catch(r){throw console.error("获取用户详情失败:",r),o.value=r.message,r}finally{u.value=!1}},createUser:async d=>{u.value=!0,o.value=null,console.log("=== 用户Store: 开始创建用户 ==="),console.log("用户数据:",d);try{const r=await P.createUser(d);return console.log("创建用户API响应:",r),await U(),r}catch(r){throw console.error("创建用户失败:",r),o.value=r.message,r}finally{u.value=!1}},updateUser:async(d,r)=>{u.value=!0,o.value=null,console.log("=== 用户Store: 开始更新用户 ==="),console.log("用户ID:",d),console.log("更新数据:",r);try{const V=await P.updateUser(d,r);return console.log("更新用户API响应:",V),await U(),V}catch(V){throw console.error("更新用户失败:",V),o.value=V.message,V}finally{u.value=!1}},deleteUser:async d=>{u.value=!0,o.value=null,console.log("=== 用户Store: 开始删除用户 ==="),console.log("用户ID:",d);try{const r=await P.deleteUser(d);return console.log("删除用户API响应:",r),await U(),r}catch(r){throw console.error("删除用户失败:",r),o.value=r.message,r}finally{u.value=!1}},clearError:()=>{o.value=null}}}),xe={class:"user-management"},Pe={class:"page-header"},$e={class:"header-actions"},Be={class:"card-header"},Me={class:"header-actions"},Le={class:"pagination-wrapper"},Ne={key:0,class:"user-detail"},qe={class:"user-info"},Re={class:"user-avatar"},Fe={class:"user-basic"},Ke={class:"user-stats"},je={class:"stat-item"},Je={class:"stat-item"},Oe={class:"stat-item"},Qe={class:"user-devices"},We={class:"device-list"},Ge={class:"device-info"},He={class:"device-id"},Xe={class:"device-actions"},Ye={__name:"UserManagement",setup(i){const g=Ee(),u=Te(),o=w(null),A=w(""),C=w(!1),k=w(!1),U=w(!1),f=w({currentPage:1,pageSize:20,total:0}),v=w({id:null,username:"",email:"",phone:"",password:"",status:"ACTIVE"}),I=w({userId:null,deviceId:""}),K={username:[{required:!0,message:"请输入用户名",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入正确的邮箱格式",trigger:"blur"}],phone:[{required:!0,message:"请输入手机号",trigger:"blur"},{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"},{min:6,message:"密码长度不能少于6位",trigger:"blur"}]},j=$(()=>{if(!A.value)return u.users;const t=A.value.toLowerCase();return u.users.filter(e=>e.username.toLowerCase().includes(t)||e.email&&e.email.toLowerCase().includes(t)||e.phone&&e.phone.includes(t))}),d=$(()=>g.devices.filter(t=>!t.user||!t.user.id)),r=async()=>{try{console.log("=== UserManagement: 开始加载用户列表 ===");const t={page:f.value.currentPage,size:f.value.pageSize,keyword:A.value||void 0};console.log("加载参数:",t);const e=await u.fetchUsers(t);console.log("=== UserManagement: 用户列表加载完成 ==="),console.log("响应数据:",e),console.log("当前用户数量:",u.users.length),console.log("用户列表:",u.users),f.value.total=e.total||0}catch(t){console.error("加载用户列表失败:",t),m.error("加载用户列表失败")}},V=async()=>{try{await g.fetchDevices()}catch(t){console.error("加载设备列表失败:",t)}},ae=()=>{r()},oe=async t=>{try{o.value=t,await u.fetchUserById(t.id),o.value=u.selectedUser}catch(e){console.error("获取用户详情失败:",e),m.error("获取用户详情失败")}},re=()=>{U.value=!1,v.value={id:null,username:"",email:"",phone:"",password:"",status:"ACTIVE"},C.value=!0},ne=t=>{U.value=!0,v.value={...t},C.value=!0},ue=async()=>{try{U.value?(await u.updateUser(v.value.id,v.value),m.success("用户更新成功")):(await u.createUser(v.value),m.success("用户添加成功")),C.value=!1}catch(t){console.error("保存用户失败:",t),m.error("保存用户失败")}},ie=async t=>{try{await F.confirm(`确认${t.status==="ACTIVE"?"禁用":"启用"}用户 ${t.username}？`,"确认操作",{type:"warning"});const e=t.status==="ACTIVE"?"INACTIVE":"ACTIVE";await u.updateUser(t.id,{...t,status:e}),m.success(`用户已${e==="ACTIVE"?"启用":"禁用"}`)}catch(e){e!=="cancel"&&(console.error("更新用户状态失败:",e),m.error("更新用户状态失败"))}},de=async t=>{try{await F.confirm(`确认删除用户 ${t.username}？此操作不可恢复。`,"确认删除",{type:"warning"}),await u.deleteUser(t.id),m.success("用户删除成功")}catch(e){e!=="cancel"&&(console.error("删除用户失败:",e),m.error("删除用户失败"))}},J=t=>o.value&&o.value.id===t&&o.value.deviceCount!==void 0?o.value.deviceCount:g.devices.filter(e=>e.userId===t).length,O=t=>o.value&&o.value.id===t&&o.value.devices?o.value.devices:g.devices.filter(e=>e.userId===t),ce=t=>{I.value.userId=t.id,I.value.deviceId="",k.value=!0},ve=async t=>{try{await F.confirm(`确认解绑设备 ${t.deviceId}？`,"确认解绑",{type:"warning"}),await g.updateDevice(t.deviceId,{userId:null}),m.success("设备解绑成功"),o.value&&(await u.fetchUserById(o.value.id),o.value=u.selectedUser),await g.fetchDevices()}catch(e){e!=="cancel"&&(console.error("解绑设备失败:",e),m.error("解绑设备失败"))}},pe=async()=>{if(!I.value.deviceId){m.warning("请选择设备");return}try{await g.updateDevice(I.value.deviceId,{userId:I.value.userId}),m.success("设备绑定成功"),k.value=!1,o.value&&(await u.fetchUserById(o.value.id),o.value=u.selectedUser),await g.fetchDevices()}catch(t){console.error("绑定设备失败:",t),m.error("绑定设备失败")}},ge=t=>{f.value.pageSize=t,f.value.currentPage=1},me=t=>{f.value.currentPage=t},M=t=>t?new Date(t).toLocaleString():"未知",L=()=>{f.value.currentPage=1,r()};return Ce(()=>{r(),V()}),(t,e)=>{const B=c("el-icon"),y=c("el-button"),z=c("el-input"),b=c("el-table-column"),Q=c("el-tag"),fe=c("el-table"),_e=c("el-pagination"),W=c("el-card"),G=c("el-col"),ye=c("el-avatar"),H=c("el-divider"),we=c("el-empty"),Ue=c("el-row"),D=c("el-form-item"),N=c("el-option"),X=c("el-select"),Y=c("el-form"),Z=c("el-dialog"),he=be("loading");return h(),E("div",xe,[n("div",Pe,[e[16]||(e[16]=n("h2",null,"用户管理",-1)),n("div",$e,[l(y,{type:"primary",onClick:re},{default:a(()=>[l(B,null,{default:a(()=>[l(S(ke))]),_:1}),e[14]||(e[14]=p(" 添加用户 ",-1))]),_:1}),l(y,{onClick:ae},{default:a(()=>[l(B,null,{default:a(()=>[l(S(De))]),_:1}),e[15]||(e[15]=p(" 刷新 ",-1))]),_:1})])]),l(Ue,{gutter:20},{default:a(()=>[l(G,{xs:24,sm:24,md:16,lg:16,xl:16},{default:a(()=>[l(W,{class:"user-list-section",shadow:"hover"},{header:a(()=>[n("div",Be,[e[18]||(e[18]=n("span",null,"用户列表",-1)),n("div",Me,[l(z,{modelValue:A.value,"onUpdate:modelValue":e[0]||(e[0]=s=>A.value=s),placeholder:"搜索用户名或手机号",size:"small",style:{width:"200px","margin-right":"10px"},clearable:"",onKeyup:Ae(L,["enter"]),onClear:L},{prefix:a(()=>[l(B,null,{default:a(()=>[l(S(se))]),_:1})]),_:1},8,["modelValue"]),l(y,{size:"small",onClick:L},{default:a(()=>[l(B,null,{default:a(()=>[l(S(se))]),_:1}),e[17]||(e[17]=p(" 搜索 ",-1))]),_:1})])])]),default:a(()=>[Ve((h(),T(fe,{data:j.value,stripe:"",style:{width:"100%"},onRowClick:oe},{default:a(()=>[l(b,{prop:"id",label:"ID",width:"80"}),l(b,{prop:"username",label:"用户名",width:"120"}),l(b,{prop:"email",label:"邮箱",width:"200"}),l(b,{prop:"phone",label:"手机号",width:"150"}),l(b,{prop:"status",label:"状态",width:"100"},{default:a(({row:s})=>[l(Q,{type:s.status==="ACTIVE"?"success":"danger",size:"small"},{default:a(()=>[p(_(s.status==="ACTIVE"?"活跃":"禁用"),1)]),_:2},1032,["type"])]),_:1}),l(b,{prop:"deviceCount",label:"关联设备",width:"100"},{default:a(({row:s})=>[p(_(J(s.id)),1)]),_:1}),l(b,{prop:"createdAt",label:"创建时间",width:"180"},{default:a(({row:s})=>[p(_(M(s.createdAt)),1)]),_:1}),l(b,{label:"操作",width:"200",fixed:"right"},{default:a(({row:s})=>[l(y,{size:"small",onClick:R(q=>ne(s),["stop"])},{default:a(()=>[...e[19]||(e[19]=[p(" 编辑 ",-1)])]),_:1},8,["onClick"]),l(y,{size:"small",type:s.status==="ACTIVE"?"warning":"success",onClick:R(q=>ie(s),["stop"])},{default:a(()=>[p(_(s.status==="ACTIVE"?"禁用":"启用"),1)]),_:2},1032,["type","onClick"]),l(y,{size:"small",type:"danger",onClick:R(q=>de(s),["stop"])},{default:a(()=>[...e[20]||(e[20]=[p(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[he,S(u).loading]]),n("div",Le,[l(_e,{"current-page":f.value.currentPage,"onUpdate:currentPage":e[1]||(e[1]=s=>f.value.currentPage=s),"page-size":f.value.pageSize,"onUpdate:pageSize":e[2]||(e[2]=s=>f.value.pageSize=s),"page-sizes":[10,20,50,100],total:f.value.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:ge,onCurrentChange:me},null,8,["current-page","page-size","total"])])]),_:1})]),_:1}),l(G,{xs:24,sm:24,md:8,lg:8,xl:8},{default:a(()=>[l(W,{class:"user-detail-section",shadow:"hover"},{header:a(()=>[...e[21]||(e[21]=[n("span",null,"用户详情",-1)])]),default:a(()=>[o.value?(h(),E("div",Ne,[n("div",qe,[n("div",Re,[l(ye,{size:80,src:o.value.avatar},{default:a(()=>[p(_(o.value.username?.charAt(0)),1)]),_:1},8,["src"])]),n("div",Fe,[n("h3",null,_(o.value.username),1),n("p",null,_(o.value.email),1),n("p",null,_(o.value.phone),1),l(Q,{type:o.value.status==="ACTIVE"?"success":"danger"},{default:a(()=>[p(_(o.value.status==="ACTIVE"?"活跃":"禁用"),1)]),_:1},8,["type"])])]),l(H),n("div",Ke,[n("div",je,[e[22]||(e[22]=n("label",null,"关联设备:",-1)),n("span",null,_(J(o.value.id))+"台",1)]),n("div",Je,[e[23]||(e[23]=n("label",null,"创建时间:",-1)),n("span",null,_(M(o.value.createdAt)),1)]),n("div",Oe,[e[24]||(e[24]=n("label",null,"最后登录:",-1)),n("span",null,_(M(o.value.lastLoginAt)),1)])]),l(H),n("div",Qe,[e[27]||(e[27]=n("h4",null,"关联设备",-1)),n("div",We,[(h(!0),E(le,null,te(O(o.value.id),s=>(h(),E("div",{key:s.deviceId,class:"device-item"},[n("div",Ge,[n("div",He,_(s.deviceId),1),l(Se,{status:s.status},null,8,["status"])]),n("div",Xe,[l(y,{size:"small",onClick:q=>ve(s)},{default:a(()=>[...e[25]||(e[25]=[p(" 解绑 ",-1)])]),_:1},8,["onClick"])])]))),128)),O(o.value.id).length===0?(h(),T(y,{key:0,size:"small",type:"primary",onClick:e[3]||(e[3]=s=>ce(o.value))},{default:a(()=>[...e[26]||(e[26]=[p(" 绑定设备 ",-1)])]),_:1})):ee("",!0)])])])):(h(),T(we,{key:1,description:"请选择用户查看详情"}))]),_:1})]),_:1})]),_:1}),l(Z,{modelValue:C.value,"onUpdate:modelValue":e[10]||(e[10]=s=>C.value=s),title:U.value?"编辑用户":"添加用户",width:"500px","close-on-click-modal":!1},{footer:a(()=>[l(y,{onClick:e[9]||(e[9]=s=>C.value=!1)},{default:a(()=>[...e[28]||(e[28]=[p("取消",-1)])]),_:1}),l(y,{type:"primary",onClick:ue},{default:a(()=>[...e[29]||(e[29]=[p("确定",-1)])]),_:1})]),default:a(()=>[l(Y,{model:v.value,rules:K,ref:"userFormRef","label-width":"80px"},{default:a(()=>[l(D,{label:"用户名",prop:"username"},{default:a(()=>[l(z,{modelValue:v.value.username,"onUpdate:modelValue":e[4]||(e[4]=s=>v.value.username=s),placeholder:"请输入用户名"},null,8,["modelValue"])]),_:1}),l(D,{label:"邮箱",prop:"email"},{default:a(()=>[l(z,{modelValue:v.value.email,"onUpdate:modelValue":e[5]||(e[5]=s=>v.value.email=s),placeholder:"请输入邮箱"},null,8,["modelValue"])]),_:1}),l(D,{label:"手机号",prop:"phone"},{default:a(()=>[l(z,{modelValue:v.value.phone,"onUpdate:modelValue":e[6]||(e[6]=s=>v.value.phone=s),placeholder:"请输入手机号"},null,8,["modelValue"])]),_:1}),U.value?ee("",!0):(h(),T(D,{key:0,label:"密码",prop:"password"},{default:a(()=>[l(z,{modelValue:v.value.password,"onUpdate:modelValue":e[7]||(e[7]=s=>v.value.password=s),type:"password",placeholder:"请输入密码"},null,8,["modelValue"])]),_:1})),l(D,{label:"状态",prop:"status"},{default:a(()=>[l(X,{modelValue:v.value.status,"onUpdate:modelValue":e[8]||(e[8]=s=>v.value.status=s),placeholder:"选择状态"},{default:a(()=>[l(N,{label:"活跃",value:"ACTIVE"}),l(N,{label:"禁用",value:"INACTIVE"})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(Z,{modelValue:k.value,"onUpdate:modelValue":e[13]||(e[13]=s=>k.value=s),title:"绑定设备",width:"400px"},{footer:a(()=>[l(y,{onClick:e[12]||(e[12]=s=>k.value=!1)},{default:a(()=>[...e[30]||(e[30]=[p("取消",-1)])]),_:1}),l(y,{type:"primary",onClick:pe},{default:a(()=>[...e[31]||(e[31]=[p("确定",-1)])]),_:1})]),default:a(()=>[l(Y,{model:I.value,"label-width":"80px"},{default:a(()=>[l(D,{label:"选择设备"},{default:a(()=>[l(X,{modelValue:I.value.deviceId,"onUpdate:modelValue":e[11]||(e[11]=s=>I.value.deviceId=s),placeholder:"选择要绑定的设备"},{default:a(()=>[(h(!0),E(le,null,te(d.value,s=>(h(),T(N,{key:s.deviceId,label:`${s.deviceId} (${s.deviceType})`,value:s.deviceId},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},sl=ze(Ye,[["__scopeId","data-v-1fb57c43"]]);export{sl as default};
