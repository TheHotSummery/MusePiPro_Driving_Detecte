import{ay as _e,r as b,c as G,h as ve,U as fe,z as ee,A as E,B as o,R as e,I as S,L,J as t,O as n,al as v,u as g,P as d,K as pe,ar as me,W as U}from"./vendor-BleAlWPf.js";import{r as ge,t as he,b as we,w as Ae,x as ye,y as be,E as y,z as Ie}from"./element-C3fiOSfn.js";import{r as T,_ as Ce,w as te}from"./index-C7PHgr5O.js";import"./charts-TxDtCNV3.js";const R={getRealtimeAlerts(){return T.get("/api/v1/platform/alerts/realtime")},getAlertHistory(c={}){return T.get("/api/v1/platform/alerts/history",{params:c})},acknowledgeAlert(c){return T.post(`/api/v1/platform/alerts/${c}/acknowledge`)},handleAlert(c,f){return T.post(`/api/v1/platform/alerts/${c}/handle`,f)}},ke=_e("alert",()=>{const c=b([]),f=b([]),I=b(!1),s=b(null),x=G(()=>({active:c.value.filter(r=>r.status==="ACTIVE").length,critical:c.value.filter(r=>r.severity==="CRITICAL").length,acknowledged:c.value.filter(r=>r.acknowledged).length,total:c.value.length})),p=G(()=>c.value.filter(r=>!r.acknowledged));return{realtimeAlerts:c,alertHistory:f,loading:I,error:s,alertCount:x,unacknowledgedAlerts:p,fetchRealtimeAlerts:async()=>{I.value=!0,s.value=null;try{const r=await R.getRealtimeAlerts();return c.value=r.alerts||[],r}catch(r){throw s.value=r.message,r}finally{I.value=!1}},fetchAlertHistory:async(r={})=>{try{const u=await R.getAlertHistory(r);return f.value=u.alerts||[],u}catch(u){throw s.value=u.message,u}},acknowledgeAlert:async r=>{try{await R.acknowledgeAlert(r);const u=c.value.find(m=>m.alertId===r);u&&(u.acknowledged=!0)}catch(u){throw s.value=u.message,u}},handleAlert:async(r,u)=>{try{await R.handleAlert(r,u);const m=c.value.find(V=>V.alertId===r);m&&(m.status="HANDLED")}catch(m){throw s.value=m.message,m}},addAlert:r=>{c.value.unshift(r)},removeAlert:r=>{const u=c.value.findIndex(m=>m.alertId===r);u>-1&&c.value.splice(u,1)},clearError:()=>{s.value=null}}}),xe={class:"alert-center"},Ee={class:"page-header"},Me={class:"header-actions"},De={class:"stat-content"},Te={class:"stat-icon"},Re={class:"stat-info"},Ve={class:"stat-value"},He={class:"stat-content"},Ne={class:"stat-icon"},Se={class:"stat-info"},Le={class:"stat-value"},Ue={class:"stat-content"},Ge={class:"stat-icon"},ze={class:"stat-info"},Oe={class:"stat-value"},$e={class:"stat-content"},Fe={class:"stat-icon"},Be={class:"stat-info"},We={class:"stat-value"},Ye={class:"card-header"},qe={class:"header-actions"},Je={class:"alert-handle-content"},Ke={class:"alert-info"},Pe={class:"handle-actions"},je={key:0,class:"alert-detail"},Qe={__name:"AlertCenter",setup(c){const f=ke(),I=b("all"),s=b(null),x=b(!1),p=b({action:"",note:""}),z=G(()=>{let a=f.realtimeAlerts;switch(I.value){case"active":return a.filter(l=>l.status==="ACTIVE");case"acknowledged":return a.filter(l=>l.acknowledged);case"critical":return a.filter(l=>l.severity==="CRITICAL");default:return a}}),M=async()=>{try{await f.fetchRealtimeAlerts()}catch(a){console.error("加载告警列表失败:",a),y.error("加载告警列表失败")}},O=()=>{M()},$=async()=>{try{await Ie.confirm("确认清空所有已处理的告警？","确认操作",{type:"warning"}),y.success("已清空已处理的告警")}catch{}},F=()=>{},B=a=>{s.value=a},W=async a=>{try{await f.acknowledgeAlert(a.alertId),y.success("告警已确认")}catch(l){console.error("确认告警失败:",l),y.error("确认告警失败")}},r=a=>{s.value=a,p.value={action:"",note:""}},u=a=>{s.value=a,x.value=!0},m=async()=>{if(!p.value.action){y.warning("请选择处理方式");return}try{await f.handleAlert(s.value.alertId,p.value),y.success("告警处理完成"),s.value=null,p.value={action:"",note:""}}catch(a){console.error("处理告警失败:",a),y.error("处理告警失败")}},V=()=>{s.value=null,p.value={action:"",note:""}},H=a=>a?new Date(a).toLocaleString():"未知",Y=a=>a?`${a.lat.toFixed(6)}, ${a.lng.toFixed(6)}`:"未知",q=a=>({LOW:"轻微",MEDIUM:"中等",HIGH:"严重",CRITICAL:"危急"})[a]||"未知",le=a=>({LOW:"success",MEDIUM:"warning",HIGH:"danger",CRITICAL:"danger"})[a]||"info",J=a=>({FATIGUE_HIGH:"疲劳严重",FATIGUE_MEDIUM:"疲劳中等",DISTRACTION_HIGH:"分心严重",DISTRACTION_MEDIUM:"分心中等",EMERGENCY:"紧急事件",SYSTEM_ERROR:"系统错误"})[a]||a,K=a=>({ACTIVE:"活跃",HANDLED:"已处理",IGNORED:"已忽略"})[a]||"未知",ae=a=>({ACTIVE:"danger",HANDLED:"success",IGNORED:"info"})[a]||"info",P=a=>{f.addAlert(a),se(a.severity),oe(a)},se=a=>{const l=new Audio;a==="CRITICAL"||a==="HIGH"?l.src="/static/audio/alert_high.mp3":a==="MEDIUM"?l.src="/static/audio/alert_mid.mp3":l.src="/static/audio/alert_low.mp3",l.play().catch(h=>console.log("无法播放告警声音:",h))},oe=a=>{y({message:`新告警: ${a.message}`,type:"warning",duration:5e3,showClose:!0})};return ve(()=>{M(),te.on("alert",P);const a=setInterval(()=>{M()},3e4);fe(()=>{clearInterval(a),te.off("alert",P)})}),(a,l)=>{const h=v("el-icon"),C=v("el-button"),k=v("el-card"),D=v("el-col"),ne=v("el-row"),w=v("el-option"),j=v("el-select"),Q=v("el-tag"),A=v("el-table-column"),re=v("el-table"),_=v("el-descriptions-item"),X=v("el-descriptions"),N=v("el-form-item"),de=v("el-input"),ie=v("el-form"),ce=v("el-dialog"),ue=me("loading");return E(),ee("div",xe,[o("div",Ee,[l[6]||(l[6]=o("h2",null,"告警中心",-1)),o("div",Me,[e(C,{onClick:O},{default:t(()=>[e(h,null,{default:t(()=>[e(g(ge))]),_:1}),l[4]||(l[4]=n(" 刷新 ",-1))]),_:1}),e(C,{onClick:$,type:"danger"},{default:t(()=>[e(h,null,{default:t(()=>[e(g(he))]),_:1}),l[5]||(l[5]=n(" 清空已处理 ",-1))]),_:1})])]),e(ne,{gutter:20,class:"alert-stats"},{default:t(()=>[e(D,{xs:12,sm:6,md:6,lg:6,xl:6},{default:t(()=>[e(k,{class:"stat-card active"},{default:t(()=>[o("div",De,[o("div",Te,[e(h,null,{default:t(()=>[e(g(we))]),_:1})]),o("div",Re,[o("div",Ve,d(g(f).alertCount.active),1),l[7]||(l[7]=o("div",{class:"stat-label"},"活跃告警",-1))])])]),_:1})]),_:1}),e(D,{xs:12,sm:6,md:6,lg:6,xl:6},{default:t(()=>[e(k,{class:"stat-card critical"},{default:t(()=>[o("div",He,[o("div",Ne,[e(h,null,{default:t(()=>[e(g(Ae))]),_:1})]),o("div",Se,[o("div",Le,d(g(f).alertCount.critical),1),l[8]||(l[8]=o("div",{class:"stat-label"},"严重告警",-1))])])]),_:1})]),_:1}),e(D,{xs:12,sm:6,md:6,lg:6,xl:6},{default:t(()=>[e(k,{class:"stat-card acknowledged"},{default:t(()=>[o("div",Ue,[o("div",Ge,[e(h,null,{default:t(()=>[e(g(ye))]),_:1})]),o("div",ze,[o("div",Oe,d(g(f).alertCount.acknowledged),1),l[9]||(l[9]=o("div",{class:"stat-label"},"已确认",-1))])])]),_:1})]),_:1}),e(D,{xs:12,sm:6,md:6,lg:6,xl:6},{default:t(()=>[e(k,{class:"stat-card total"},{default:t(()=>[o("div",$e,[o("div",Fe,[e(h,null,{default:t(()=>[e(g(be))]),_:1})]),o("div",Be,[o("div",We,d(g(f).alertCount.total),1),l[10]||(l[10]=o("div",{class:"stat-label"},"总告警数",-1))])])]),_:1})]),_:1})]),_:1}),e(k,{class:"alert-list-section",shadow:"hover"},{header:t(()=>[o("div",Ye,[l[11]||(l[11]=o("span",null,"实时告警列表",-1)),o("div",qe,[e(j,{modelValue:I.value,"onUpdate:modelValue":l[0]||(l[0]=i=>I.value=i),onChange:F,size:"small",style:{width:"150px"}},{default:t(()=>[e(w,{label:"全部",value:"all"}),e(w,{label:"活跃",value:"active"}),e(w,{label:"已确认",value:"acknowledged"}),e(w,{label:"严重",value:"critical"})]),_:1},8,["modelValue"])])])]),default:t(()=>[pe((E(),S(re,{data:z.value,stripe:"",style:{width:"100%"},onRowClick:B},{default:t(()=>[e(A,{prop:"severity",label:"严重程度",width:"100"},{default:t(({row:i})=>[e(Q,{type:le(i.severity),size:"small"},{default:t(()=>[n(d(q(i.severity)),1)]),_:2},1032,["type"])]),_:1}),e(A,{prop:"timestamp",label:"时间",width:"180"},{default:t(({row:i})=>[n(d(H(i.timestamp)),1)]),_:1}),e(A,{prop:"deviceId",label:"设备ID",width:"150"}),e(A,{prop:"username",label:"驾驶员",width:"120"},{default:t(({row:i})=>[n(d(i.user?.username||"未知"),1)]),_:1}),e(A,{prop:"alertType",label:"告警类型",width:"150"},{default:t(({row:i})=>[n(d(J(i.alertType)),1)]),_:1}),e(A,{prop:"message",label:"告警信息","min-width":"200","show-overflow-tooltip":""}),e(A,{prop:"status",label:"状态",width:"100"},{default:t(({row:i})=>[e(Q,{type:ae(i.status),size:"small"},{default:t(()=>[n(d(K(i.status)),1)]),_:2},1032,["type"])]),_:1}),e(A,{label:"操作",width:"200",fixed:"right"},{default:t(({row:i})=>[i.acknowledged?L("",!0):(E(),S(C,{key:0,size:"small",type:"primary",onClick:U(Z=>W(i),["stop"])},{default:t(()=>[...l[12]||(l[12]=[n(" 确认 ",-1)])]),_:1},8,["onClick"])),e(C,{size:"small",type:"success",onClick:U(Z=>r(i),["stop"])},{default:t(()=>[...l[13]||(l[13]=[n(" 处理 ",-1)])]),_:1},8,["onClick"]),e(C,{size:"small",onClick:U(Z=>u(i),["stop"])},{default:t(()=>[...l[14]||(l[14]=[n(" 详情 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[ue,g(f).loading]])]),_:1}),s.value?(E(),S(k,{key:0,class:"alert-handle-section",shadow:"hover"},{header:t(()=>[...l[15]||(l[15]=[o("span",null,"告警处理",-1)])]),default:t(()=>[o("div",Je,[o("div",Ke,[o("h4",null,d(s.value.message),1),e(X,{column:2,border:"",size:"small"},{default:t(()=>[e(_,{label:"告警ID"},{default:t(()=>[n(d(s.value.alertId),1)]),_:1}),e(_,{label:"设备"},{default:t(()=>[n(d(s.value.deviceId)+" ("+d(s.value.user?.username)+")",1)]),_:1}),e(_,{label:"时间"},{default:t(()=>[n(d(H(s.value.timestamp)),1)]),_:1}),e(_,{label:"位置"},{default:t(()=>[n(d(Y(s.value.location)),1)]),_:1}),e(_,{label:"详情",span:2},{default:t(()=>[n(d(s.value.message),1)]),_:1})]),_:1})]),o("div",Pe,[e(ie,{model:p.value,"label-width":"80px"},{default:t(()=>[e(N,{label:"处理方式"},{default:t(()=>[e(j,{modelValue:p.value.action,"onUpdate:modelValue":l[1]||(l[1]=i=>p.value.action=i),placeholder:"选择处理方式"},{default:t(()=>[e(w,{label:"电话联系",value:"call"}),e(w,{label:"短信通知",value:"sms"}),e(w,{label:"现场处理",value:"onsite"}),e(w,{label:"忽略告警",value:"ignore"})]),_:1},8,["modelValue"])]),_:1}),e(N,{label:"处理备注"},{default:t(()=>[e(de,{modelValue:p.value.note,"onUpdate:modelValue":l[2]||(l[2]=i=>p.value.note=i),type:"textarea",placeholder:"请输入处理备注",rows:3},null,8,["modelValue"])]),_:1}),e(N,null,{default:t(()=>[e(C,{type:"primary",onClick:m},{default:t(()=>[...l[16]||(l[16]=[n("提交处理",-1)])]),_:1}),e(C,{onClick:V},{default:t(()=>[...l[17]||(l[17]=[n("取消",-1)])]),_:1})]),_:1})]),_:1},8,["model"])])])]),_:1})):L("",!0),e(ce,{modelValue:x.value,"onUpdate:modelValue":l[3]||(l[3]=i=>x.value=i),title:"告警详情",width:"600px"},{default:t(()=>[s.value?(E(),ee("div",je,[e(X,{column:2,border:""},{default:t(()=>[e(_,{label:"告警ID"},{default:t(()=>[n(d(s.value.alertId),1)]),_:1}),e(_,{label:"设备ID"},{default:t(()=>[n(d(s.value.deviceId),1)]),_:1}),e(_,{label:"驾驶员"},{default:t(()=>[n(d(s.value.user?.username||"未知"),1)]),_:1}),e(_,{label:"联系方式"},{default:t(()=>[n(d(s.value.user?.phone||"未知"),1)]),_:1}),e(_,{label:"告警类型"},{default:t(()=>[n(d(J(s.value.alertType)),1)]),_:1}),e(_,{label:"严重程度"},{default:t(()=>[n(d(q(s.value.severity)),1)]),_:1}),e(_,{label:"状态"},{default:t(()=>[n(d(K(s.value.status)),1)]),_:1}),e(_,{label:"确认状态"},{default:t(()=>[n(d(s.value.acknowledged?"已确认":"未确认"),1)]),_:1}),e(_,{label:"发生时间",span:2},{default:t(()=>[n(d(H(s.value.timestamp)),1)]),_:1}),e(_,{label:"位置",span:2},{default:t(()=>[n(d(Y(s.value.location)),1)]),_:1}),e(_,{label:"告警信息",span:2},{default:t(()=>[n(d(s.value.message),1)]),_:1})]),_:1})])):L("",!0)]),_:1},8,["modelValue"])])}}},lt=Ce(Qe,[["__scopeId","data-v-033f1eae"]]);export{lt as default};
