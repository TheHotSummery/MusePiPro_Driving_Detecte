import{r as ae,o as le,E as V}from"./element-DCn9y4rn.js";import{_ as oe,a as ne,b as re,S as I,F as ie,E as ce,H as de}from"./index-D7UZbDsL.js";import{r as k,c as Y,h as ue,U as ve,z as w,A as m,B as o,R as s,I as P,L as me,J as l,al as c,O as h,u as U,Q as $,a6 as O,P as i,K as he,ar as fe,D as ge}from"./vendor-BleAlWPf.js";import"./charts-TxDtCNV3.js";const _e={class:"analytics"},pe={class:"page-header"},ye={class:"header-actions"},ke={class:"health-analysis"},Se={class:"device-info"},we={class:"device-id"},De={class:"device-user"},be={class:"health-score"},xe={class:"time-analysis"},Ee={class:"time-label"},Ie={class:"time-bar"},Me={class:"time-count"},Te={class:"risk-analysis"},Re={class:"risk-item"},He={class:"risk-value"},Le={class:"risk-item"},Ce={class:"risk-value"},Ae={class:"risk-item"},Ve={class:"risk-value"},Ye={class:"risk-item"},Pe={class:"risk-value"},Ue={class:"card-header"},$e={__name:"Analytics",setup(Oe){const M=ne(),T=re(),f=k("all"),g=k([]),S=k(!1),d=k({}),H=k([]),_=k([]),L=Y(()=>{const t={};for(let e=0;e<12;e++){const a=e*2,r=a+2,p=`${a.toString().padStart(2,"0")}:00-${r.toString().padStart(2,"0")}:00`;t[p]=0}return d.value.events&&d.value.events.forEach(e=>{const a=new Date(e.timestamp).getHours(),p=Math.floor(a/2)*2,x=p+2,E=`${p.toString().padStart(2,"0")}:00-${x.toString().padStart(2,"0")}:00`;t[E]++}),t}),D=Y(()=>{const t={highRisk:0,mediumRisk:0,lowRisk:0,averageRisk:0};if(_.value.length>0){_.value.forEach(a=>{a.riskLevel==="HIGH"?t.highRisk++:a.riskLevel==="MEDIUM"?t.mediumRisk++:t.lowRisk++});const e=_.value.reduce((a,r)=>a+r.safetyScore,0);t.averageRisk=Math.round(e/_.value.length)}return t}),b=async()=>{S.value=!0;try{const t=W();await Promise.all([z(t),B()])}catch(t){console.error("加载分析数据失败:",t),V.error("加载分析数据失败")}finally{S.value=!1}},z=async t=>{try{console.log("=== Analytics: 开始加载事件统计 ===");const e=await M.fetchEventStatistics(t);console.log("事件统计API响应:",e);let a=[];try{a=(await M.fetchEvents(t)).events||[],console.log("独立获取的事件列表:",a.length,"个事件")}catch(r){console.warn("获取事件列表失败，使用空数组:",r)}d.value={totalEvents:e.totalEvents||0,fatigueEvents:e.eventTypes?.fatigue||0,distractionEvents:e.eventTypes?.distraction||0,emergencyEvents:e.eventTypes?.emergency||0,averageSafetyScore:e.deviceStatistics?.averageSafetyScore||0,hourlyDistribution:e.hourlyDistribution||[],severityLevels:e.severityLevels||{},eventTypes:e.eventTypes||{},events:a},console.log("处理后的分析数据:",d.value)}catch(e){console.error("加载事件统计失败:",e)}},B=async()=>{try{await T.fetchDevices();const t=T.devices.map(async a=>{try{const r=await M.fetchDrivingBehaviorAnalysis(a.deviceId,{});return{deviceId:a.deviceId,username:a.username,...r.statistics,healthScore:a.healthScore,riskLevel:Q(r.statistics?.safetyScore||0)}}catch(r){return console.error(`获取设备 ${a.deviceId} 分析失败:`,r),{deviceId:a.deviceId,username:a.username,totalEvents:0,fatigueEvents:0,distractionEvents:0,totalDrivingTime:0,totalDistance:0,averageSpeed:0,safetyScore:0,healthScore:a.healthScore,riskLevel:"LOW"}}}),e=await Promise.all(t);_.value=e,H.value=T.devices.map(a=>({deviceId:a.deviceId,username:a.username,healthScore:a.healthScore||0}))}catch(t){console.error("加载设备分析失败:",t)}},W=()=>{if(f.value==="all"||!f.value)return{};const t=new Date;let e,a;switch(f.value){case"today":e=new Date(t.getFullYear(),t.getMonth(),t.getDate()),a=t;break;case"week":e=new Date(t.getTime()-10080*60*1e3),a=t;break;case"month":e=new Date(t.getFullYear(),t.getMonth(),1),a=t;break;case"custom":if(g.value&&g.value.length===2)e=new Date(g.value[0]),a=new Date(g.value[1]);else return{};break;default:return{}}return{startTime:e.toISOString(),endTime:a.toISOString()}},F=()=>{b()},G=t=>{console.log("图表类型变化:",t)},N=t=>{console.log("周期变化:",t)},j=()=>{b()},J=()=>{V.info("导出功能开发中...")},K=t=>{const e=Math.max(...Object.values(L.value));return e===0?"0%":`${t/e*100}%`},Q=t=>t>=80?"LOW":t>=60?"MEDIUM":"HIGH",q=t=>({LOW:"低风险",MEDIUM:"中风险",HIGH:"高风险"})[t]||"未知",X=t=>({LOW:"success",MEDIUM:"warning",HIGH:"danger"})[t]||"info",Z=t=>t>=80?"success":t>=60?"warning":"danger",ee=t=>{if(!t)return"0分钟";const e=Math.floor(t/3600),a=Math.floor(t%3600/60);return e>0?`${e}小时${a}分钟`:`${a}分钟`};return ue(()=>{b();const t=setInterval(()=>{b()},3e5);ve(()=>{clearInterval(t)})}),(t,e)=>{const a=c("el-option"),r=c("el-select"),p=c("el-date-picker"),x=c("el-icon"),E=c("el-button"),v=c("el-col"),R=c("el-row"),y=c("el-card"),u=c("el-table-column"),C=c("el-tag"),te=c("el-table"),se=fe("loading");return m(),w("div",_e,[o("div",pe,[e[3]||(e[3]=o("h2",null,"数据分析",-1)),o("div",ye,[s(r,{modelValue:f.value,"onUpdate:modelValue":e[0]||(e[0]=n=>f.value=n),onChange:F,size:"small"},{default:l(()=>[s(a,{label:"全部",value:"all"}),s(a,{label:"今日",value:"today"}),s(a,{label:"本周",value:"week"}),s(a,{label:"本月",value:"month"}),s(a,{label:"自定义",value:"custom"})]),_:1},8,["modelValue"]),f.value==="custom"?(m(),P(p,{key:0,modelValue:g.value,"onUpdate:modelValue":e[1]||(e[1]=n=>g.value=n),type:"datetimerange","range-separator":"至","start-placeholder":"开始时间","end-placeholder":"结束时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DDTHH:mm:ss",size:"small",style:{width:"350px"}},null,8,["modelValue"])):me("",!0),s(E,{onClick:j},{default:l(()=>[s(x,null,{default:l(()=>[s(U(ae))]),_:1}),e[2]||(e[2]=h(" 刷新 ",-1))]),_:1})])]),s(R,{gutter:20,class:"overview-section"},{default:l(()=>[s(v,{xs:12,sm:6,md:6,lg:6,xl:6},{default:l(()=>[s(I,{title:"总事件数",value:d.value.totalEvents||0,icon:"Warning",color:"warning",suffix:"起"},null,8,["value"])]),_:1}),s(v,{xs:12,sm:6,md:6,lg:6,xl:6},{default:l(()=>[s(I,{title:"疲劳事件",value:d.value.fatigueEvents||0,icon:"User",color:"danger",suffix:"起"},null,8,["value"])]),_:1}),s(v,{xs:12,sm:6,md:6,lg:6,xl:6},{default:l(()=>[s(I,{title:"分心事件",value:d.value.distractionEvents||0,icon:"View",color:"info",suffix:"起"},null,8,["value"])]),_:1}),s(v,{xs:12,sm:6,md:6,lg:6,xl:6},{default:l(()=>[s(I,{title:"平均安全评分",value:d.value.averageSafetyScore||0,icon:"Star",color:"success",suffix:"分"},null,8,["value"])]),_:1})]),_:1}),s(R,{gutter:20,class:"charts-section"},{default:l(()=>[s(v,{xs:24,sm:24,md:12,lg:12,xl:12},{default:l(()=>[s(y,{class:"chart-card",shadow:"hover"},{header:l(()=>[...e[4]||(e[4]=[o("span",null,"驾驶行为分析",-1)])]),default:l(()=>[s(ie,{data:d.value.events||[],loading:S.value,onTypeChange:G},null,8,["data","loading"])]),_:1})]),_:1}),s(v,{xs:24,sm:24,md:12,lg:12,xl:12},{default:l(()=>[s(y,{class:"chart-card",shadow:"hover"},{header:l(()=>[...e[5]||(e[5]=[o("span",null,"事件趋势分析",-1)])]),default:l(()=>[s(ce,{data:d.value.events||[],loading:S.value,onPeriodChange:N},null,8,["data","loading"])]),_:1})]),_:1})]),_:1}),s(R,{gutter:20,class:"detailed-section"},{default:l(()=>[s(v,{xs:24,sm:24,md:8,lg:8,xl:8},{default:l(()=>[s(y,{class:"analysis-card",shadow:"hover"},{header:l(()=>[...e[6]||(e[6]=[o("span",null,"设备网络健康状态分析",-1)])]),default:l(()=>[o("div",ke,[(m(!0),w($,null,O(H.value,n=>(m(),w("div",{key:n.deviceId,class:"health-item"},[o("div",Se,[o("div",we,i(n.deviceId),1),o("div",De,i(n.username),1)]),o("div",be,[s(de,{score:n.healthScore},null,8,["score"])])]))),128))])]),_:1})]),_:1}),s(v,{xs:24,sm:24,md:8,lg:8,xl:8},{default:l(()=>[s(y,{class:"analysis-card",shadow:"hover"},{header:l(()=>[...e[7]||(e[7]=[o("span",null,"时间段分析",-1)])]),default:l(()=>[o("div",xe,[(m(!0),w($,null,O(L.value,(n,A)=>(m(),w("div",{key:A,class:"time-item"},[o("div",Ee,i(A),1),o("div",Ie,[o("div",{class:"time-fill",style:ge({width:K(n)})},null,4)]),o("div",Me,i(n),1)]))),128))])]),_:1})]),_:1}),s(v,{xs:24,sm:24,md:8,lg:8,xl:8},{default:l(()=>[s(y,{class:"analysis-card",shadow:"hover"},{header:l(()=>[...e[8]||(e[8]=[o("span",null,"风险评估",-1)])]),default:l(()=>[o("div",Te,[o("div",Re,[e[9]||(e[9]=o("div",{class:"risk-label"},"高风险设备",-1)),o("div",He,i(D.value.highRisk),1)]),o("div",Le,[e[10]||(e[10]=o("div",{class:"risk-label"},"中风险设备",-1)),o("div",Ce,i(D.value.mediumRisk),1)]),o("div",Ae,[e[11]||(e[11]=o("div",{class:"risk-label"},"低风险设备",-1)),o("div",Ve,i(D.value.lowRisk),1)]),o("div",Ye,[e[12]||(e[12]=o("div",{class:"risk-label"},"平均风险评分",-1)),o("div",Pe,i(D.value.averageRisk),1)])])]),_:1})]),_:1})]),_:1}),s(y,{class:"device-analysis-section",shadow:"hover"},{header:l(()=>[o("div",Ue,[e[14]||(e[14]=o("span",null,"设备详细分析",-1)),s(E,{onClick:J,size:"small"},{default:l(()=>[s(x,null,{default:l(()=>[s(U(le))]),_:1}),e[13]||(e[13]=h(" 导出报告 ",-1))]),_:1})])]),default:l(()=>[he((m(),P(te,{data:_.value,stripe:"",style:{width:"100%"}},{default:l(()=>[s(u,{prop:"deviceId",label:"设备ID",width:"150"}),s(u,{prop:"username",label:"驾驶员",width:"120"}),s(u,{prop:"totalEvents",label:"总事件数",width:"100"}),s(u,{prop:"fatigueEvents",label:"疲劳事件",width:"100"}),s(u,{prop:"distractionEvents",label:"分心事件",width:"100"}),s(u,{prop:"totalDrivingTime",label:"驾驶时长",width:"120"},{default:l(({row:n})=>[h(i(ee(n.totalDrivingTime)),1)]),_:1}),s(u,{prop:"totalDistance",label:"行驶距离",width:"100"},{default:l(({row:n})=>[h(i(n.totalDistance)+" km ",1)]),_:1}),s(u,{prop:"averageSpeed",label:"平均速度",width:"100"},{default:l(({row:n})=>[h(i(n.averageSpeed)+" km/h ",1)]),_:1}),s(u,{prop:"safetyScore",label:"安全评分",width:"100"},{default:l(({row:n})=>[s(C,{type:Z(n.safetyScore),size:"small"},{default:l(()=>[h(i(n.safetyScore)+"分 ",1)]),_:2},1032,["type"])]),_:1}),s(u,{prop:"riskLevel",label:"风险等级",width:"100"},{default:l(({row:n})=>[s(C,{type:X(n.riskLevel),size:"small"},{default:l(()=>[h(i(q(n.riskLevel)),1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data"])),[[se,S.value]])]),_:1})])}}},Ge=oe($e,[["__scopeId","data-v-a8c21c47"]]);export{Ge as default};
