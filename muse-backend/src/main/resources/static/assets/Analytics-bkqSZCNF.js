import{r as oe,n as ne,E as G}from"./element-C3fiOSfn.js";import{_ as J,u as re,a as ie,S as $,E as ce,H as ue}from"./index-C7PHgr5O.js";import{u as de,E as ve,i as me,g as he,h as pe,b as fe,c as ge,d as ye,e as _e}from"./charts-TxDtCNV3.js";import{r as E,c as W,j as Se,al as m,z as A,A as b,B as o,R as t,J as l,u as Y,h as be,U as we,I as B,L as ke,O as D,Q as N,a6 as j,P as v,K as De,ar as Ee,D as xe}from"./vendor-BleAlWPf.js";const Ie={class:"fatigue-analysis-chart"},Ce={class:"chart-header"},Te={__name:"FatigueAnalysisChart",props:{data:{type:Array,default:()=>[]},loading:{type:Boolean,default:!1}},emits:["type-change"],setup(U,{emit:M}){de([me,he,pe,fe,ge,ye,_e]);const y=U,_=M,p=E("hourly"),w=W(()=>{switch(p.value){case"hourly":return d();case"severity":return H();case"behavior":return S();default:return d()}}),d=()=>{const n=L();return{title:{text:"疲劳事件小时分布",left:"center",textStyle:{fontSize:16,fontWeight:"normal"}},tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},grid:{left:"3%",right:"4%",bottom:"3%",top:"15%",containLabel:!0},xAxis:{type:"category",data:n.labels,axisLabel:{formatter:"{value}:00"}},yAxis:{type:"value",name:"事件数量"},series:[{name:"疲劳事件",type:"bar",data:n.values,itemStyle:{color:"#E6A23C"},emphasis:{itemStyle:{color:"#D4941E"}}}]}},H=()=>{const n=x();return{title:{text:"疲劳事件严重程度分布",left:"center",textStyle:{fontSize:16,fontWeight:"normal"}},tooltip:{trigger:"item",formatter:"{a} <br/>{b}: {c} ({d}%)"},legend:{orient:"vertical",left:"left",top:"middle"},series:[{name:"严重程度",type:"pie",radius:["40%","70%"],center:["60%","50%"],data:n,emphasis:{itemStyle:{shadowBlur:10,shadowOffsetX:0,shadowColor:"rgba(0, 0, 0, 0.5)"}},label:{show:!0,formatter:"{b}: {c}"}}]}},S=()=>{const n=I();return{title:{text:"疲劳行为类型分布",left:"center",textStyle:{fontSize:16,fontWeight:"normal"}},tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},grid:{left:"3%",right:"4%",bottom:"3%",top:"15%",containLabel:!0},xAxis:{type:"category",data:n.labels},yAxis:{type:"value",name:"事件数量"},series:[{name:"行为类型",type:"bar",data:n.values,itemStyle:{color:"#409EFF"},emphasis:{itemStyle:{color:"#337ECC"}}}]}},L=()=>{const n=new Array(24).fill(0);return y.data.forEach(c=>{if(c.eventType==="FATIGUE"){const i=new Date(c.timestamp).getHours();n[i]++}}),{labels:Array.from({length:24},(c,i)=>i),values:n}},x=()=>{const n={LOW:0,MEDIUM:0,HIGH:0,CRITICAL:0};y.data.forEach(h=>{h.eventType==="FATIGUE"&&n.hasOwnProperty(h.severity)&&n[h.severity]++});const c={LOW:"#67C23A",MEDIUM:"#E6A23C",HIGH:"#F56C6C",CRITICAL:"#F56C6C"},i={LOW:"轻微",MEDIUM:"中等",HIGH:"严重",CRITICAL:"危急"};return Object.entries(n).filter(([h,k])=>k>0).map(([h,k])=>({value:k,name:i[h],itemStyle:{color:c[h]}}))},I=()=>{const n={};y.data.forEach(i=>{i.eventType==="FATIGUE"&&i.behavior&&(n[i.behavior]=(n[i.behavior]||0)+1)});const c={EYE_CLOSURE:"闭眼",YAWNING:"打哈欠",HEAD_NODDING:"点头",DISTRACTED:"分心",SLEEPY:"困倦"};return{labels:Object.keys(n).map(i=>c[i]||i),values:Object.values(n)}},V=n=>{_("type-change",n)};return Se(()=>y.data,()=>{},{deep:!0}),(n,c)=>{const i=m("el-option"),h=m("el-select");return b(),A("div",Ie,[o("div",Ce,[c[1]||(c[1]=o("h3",null,"疲劳行为分析",-1)),t(h,{modelValue:p.value,"onUpdate:modelValue":c[0]||(c[0]=k=>p.value=k),onChange:V,size:"small"},{default:l(()=>[t(i,{label:"小时分布",value:"hourly"}),t(i,{label:"严重程度",value:"severity"}),t(i,{label:"行为类型",value:"behavior"})]),_:1},8,["modelValue"])]),t(Y(ve),{class:"chart",option:w.value,loading:U.loading,autoresize:""},null,8,["option","loading"])])}}},Ae=J(Te,[["__scopeId","data-v-36b3a857"]]),Me={class:"analytics"},He={class:"page-header"},Le={class:"header-actions"},Re={class:"health-analysis"},Oe={class:"device-info"},$e={class:"device-id"},Ue={class:"device-user"},Ve={class:"health-score"},Pe={class:"time-analysis"},We={class:"time-label"},Ye={class:"time-bar"},ze={class:"time-count"},Fe={class:"risk-analysis"},Ge={class:"risk-item"},Be={class:"risk-value"},Ne={class:"risk-item"},je={class:"risk-value"},Je={class:"risk-item"},Ke={class:"risk-value"},Qe={class:"risk-item"},Xe={class:"risk-value"},qe={class:"card-header"},Ze={__name:"Analytics",setup(U){const M=re(),y=ie(),_=E("all"),p=E([]),w=E(!1),d=E({}),H=E([]),S=E([]),L=W(()=>{const a={};for(let e=0;e<12;e++){const s=e*2,u=s+2,C=`${s.toString().padStart(2,"0")}:00-${u.toString().padStart(2,"0")}:00`;a[C]=0}return d.value.events&&d.value.events.forEach(e=>{const s=new Date(e.timestamp).getHours(),C=Math.floor(s/2)*2,R=C+2,O=`${C.toString().padStart(2,"0")}:00-${R.toString().padStart(2,"0")}:00`;a[O]++}),a}),x=W(()=>{const a={highRisk:0,mediumRisk:0,lowRisk:0,averageRisk:0};if(S.value.length>0){S.value.forEach(s=>{s.riskLevel==="HIGH"?a.highRisk++:s.riskLevel==="MEDIUM"?a.mediumRisk++:a.lowRisk++});const e=S.value.reduce((s,u)=>s+u.safetyScore,0);a.averageRisk=Math.round(e/S.value.length)}return a}),I=async()=>{w.value=!0;try{const a=c();await Promise.all([V(a),n()])}catch(a){console.error("加载分析数据失败:",a),G.error("加载分析数据失败")}finally{w.value=!1}},V=async a=>{try{console.log("=== Analytics: 开始加载事件统计 ===");const e=await M.fetchEventStatistics(a);console.log("事件统计API响应:",e);let s=[];try{s=(await M.fetchEvents(a)).events||[],console.log("独立获取的事件列表:",s.length,"个事件")}catch(u){console.warn("获取事件列表失败，使用空数组:",u)}d.value={totalEvents:e.totalEvents||0,fatigueEvents:e.eventTypes?.fatigue||0,distractionEvents:e.eventTypes?.distraction||0,emergencyEvents:e.eventTypes?.emergency||0,averageSafetyScore:e.deviceStatistics?.averageSafetyScore||0,hourlyDistribution:e.hourlyDistribution||[],severityLevels:e.severityLevels||{},eventTypes:e.eventTypes||{},events:s},console.log("处理后的分析数据:",d.value)}catch(e){console.error("加载事件统计失败:",e)}},n=async()=>{try{await y.fetchDevices();const a=y.devices.map(async s=>{try{const u=await M.fetchDrivingBehaviorAnalysis(s.deviceId,{});return{deviceId:s.deviceId,username:s.username,...u.statistics,healthScore:s.healthScore,riskLevel:q(u.statistics?.safetyScore||0)}}catch(u){return console.error(`获取设备 ${s.deviceId} 分析失败:`,u),{deviceId:s.deviceId,username:s.username,totalEvents:0,fatigueEvents:0,distractionEvents:0,totalDrivingTime:0,totalDistance:0,averageSpeed:0,safetyScore:0,healthScore:s.healthScore,riskLevel:"LOW"}}}),e=await Promise.all(a);S.value=e,H.value=y.devices.map(s=>({deviceId:s.deviceId,username:s.username,healthScore:s.healthScore||0}))}catch(a){console.error("加载设备分析失败:",a)}},c=()=>{if(_.value==="all"||!_.value)return{};const a=new Date;let e,s;switch(_.value){case"today":e=new Date(a.getFullYear(),a.getMonth(),a.getDate()),s=a;break;case"week":e=new Date(a.getTime()-10080*60*1e3),s=a;break;case"month":e=new Date(a.getFullYear(),a.getMonth(),1),s=a;break;case"custom":if(p.value&&p.value.length===2)e=new Date(p.value[0]),s=new Date(p.value[1]);else return{};break;default:return{}}return{startTime:e.toISOString(),endTime:s.toISOString()}},i=()=>{I()},h=a=>{console.log("图表类型变化:",a)},k=a=>{console.log("周期变化:",a)},K=()=>{I()},Q=()=>{G.info("导出功能开发中...")},X=a=>{const e=Math.max(...Object.values(L.value));return e===0?"0%":`${a/e*100}%`},q=a=>a>=80?"LOW":a>=60?"MEDIUM":"HIGH",Z=a=>({LOW:"低风险",MEDIUM:"中风险",HIGH:"高风险"})[a]||"未知",ee=a=>({LOW:"success",MEDIUM:"warning",HIGH:"danger"})[a]||"info",te=a=>a>=80?"success":a>=60?"warning":"danger",ae=a=>{if(!a)return"0分钟";const e=Math.floor(a/3600),s=Math.floor(a%3600/60);return e>0?`${e}小时${s}分钟`:`${s}分钟`};return be(()=>{I();const a=setInterval(()=>{I()},3e5);we(()=>{clearInterval(a)})}),(a,e)=>{const s=m("el-option"),u=m("el-select"),C=m("el-date-picker"),R=m("el-icon"),O=m("el-button"),g=m("el-col"),P=m("el-row"),T=m("el-card"),f=m("el-table-column"),z=m("el-tag"),se=m("el-table"),le=Ee("loading");return b(),A("div",Me,[o("div",He,[e[3]||(e[3]=o("h2",null,"数据分析",-1)),o("div",Le,[t(u,{modelValue:_.value,"onUpdate:modelValue":e[0]||(e[0]=r=>_.value=r),onChange:i,size:"small"},{default:l(()=>[t(s,{label:"全部",value:"all"}),t(s,{label:"今日",value:"today"}),t(s,{label:"本周",value:"week"}),t(s,{label:"本月",value:"month"}),t(s,{label:"自定义",value:"custom"})]),_:1},8,["modelValue"]),_.value==="custom"?(b(),B(C,{key:0,modelValue:p.value,"onUpdate:modelValue":e[1]||(e[1]=r=>p.value=r),type:"datetimerange","range-separator":"至","start-placeholder":"开始时间","end-placeholder":"结束时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DDTHH:mm:ss",size:"small",style:{width:"350px"}},null,8,["modelValue"])):ke("",!0),t(O,{onClick:K},{default:l(()=>[t(R,null,{default:l(()=>[t(Y(oe))]),_:1}),e[2]||(e[2]=D(" 刷新 ",-1))]),_:1})])]),t(P,{gutter:20,class:"overview-section"},{default:l(()=>[t(g,{xs:12,sm:6,md:6,lg:6,xl:6},{default:l(()=>[t($,{title:"总事件数",value:d.value.totalEvents||0,icon:"Warning",color:"warning",suffix:"起"},null,8,["value"])]),_:1}),t(g,{xs:12,sm:6,md:6,lg:6,xl:6},{default:l(()=>[t($,{title:"疲劳事件",value:d.value.fatigueEvents||0,icon:"User",color:"danger",suffix:"起"},null,8,["value"])]),_:1}),t(g,{xs:12,sm:6,md:6,lg:6,xl:6},{default:l(()=>[t($,{title:"分心事件",value:d.value.distractionEvents||0,icon:"View",color:"info",suffix:"起"},null,8,["value"])]),_:1}),t(g,{xs:12,sm:6,md:6,lg:6,xl:6},{default:l(()=>[t($,{title:"平均安全评分",value:d.value.averageSafetyScore||0,icon:"Star",color:"success",suffix:"分"},null,8,["value"])]),_:1})]),_:1}),t(P,{gutter:20,class:"charts-section"},{default:l(()=>[t(g,{xs:24,sm:24,md:12,lg:12,xl:12},{default:l(()=>[t(T,{class:"chart-card",shadow:"hover"},{header:l(()=>[...e[4]||(e[4]=[o("span",null,"驾驶行为分析",-1)])]),default:l(()=>[t(Ae,{data:d.value.events||[],loading:w.value,onTypeChange:h},null,8,["data","loading"])]),_:1})]),_:1}),t(g,{xs:24,sm:24,md:12,lg:12,xl:12},{default:l(()=>[t(T,{class:"chart-card",shadow:"hover"},{header:l(()=>[...e[5]||(e[5]=[o("span",null,"事件趋势分析",-1)])]),default:l(()=>[t(ce,{data:d.value.events||[],loading:w.value,onPeriodChange:k},null,8,["data","loading"])]),_:1})]),_:1})]),_:1}),t(P,{gutter:20,class:"detailed-section"},{default:l(()=>[t(g,{xs:24,sm:24,md:8,lg:8,xl:8},{default:l(()=>[t(T,{class:"analysis-card",shadow:"hover"},{header:l(()=>[...e[6]||(e[6]=[o("span",null,"设备健康度分析",-1)])]),default:l(()=>[o("div",Re,[(b(!0),A(N,null,j(H.value,r=>(b(),A("div",{key:r.deviceId,class:"health-item"},[o("div",Oe,[o("div",$e,v(r.deviceId),1),o("div",Ue,v(r.username),1)]),o("div",Ve,[t(ue,{score:r.healthScore},null,8,["score"])])]))),128))])]),_:1})]),_:1}),t(g,{xs:24,sm:24,md:8,lg:8,xl:8},{default:l(()=>[t(T,{class:"analysis-card",shadow:"hover"},{header:l(()=>[...e[7]||(e[7]=[o("span",null,"时间段分析",-1)])]),default:l(()=>[o("div",Pe,[(b(!0),A(N,null,j(L.value,(r,F)=>(b(),A("div",{key:F,class:"time-item"},[o("div",We,v(F),1),o("div",Ye,[o("div",{class:"time-fill",style:xe({width:X(r)})},null,4)]),o("div",ze,v(r),1)]))),128))])]),_:1})]),_:1}),t(g,{xs:24,sm:24,md:8,lg:8,xl:8},{default:l(()=>[t(T,{class:"analysis-card",shadow:"hover"},{header:l(()=>[...e[8]||(e[8]=[o("span",null,"风险评估",-1)])]),default:l(()=>[o("div",Fe,[o("div",Ge,[e[9]||(e[9]=o("div",{class:"risk-label"},"高风险设备",-1)),o("div",Be,v(x.value.highRisk),1)]),o("div",Ne,[e[10]||(e[10]=o("div",{class:"risk-label"},"中风险设备",-1)),o("div",je,v(x.value.mediumRisk),1)]),o("div",Je,[e[11]||(e[11]=o("div",{class:"risk-label"},"低风险设备",-1)),o("div",Ke,v(x.value.lowRisk),1)]),o("div",Qe,[e[12]||(e[12]=o("div",{class:"risk-label"},"平均风险评分",-1)),o("div",Xe,v(x.value.averageRisk),1)])])]),_:1})]),_:1})]),_:1}),t(T,{class:"device-analysis-section",shadow:"hover"},{header:l(()=>[o("div",qe,[e[14]||(e[14]=o("span",null,"设备详细分析",-1)),t(O,{onClick:Q,size:"small"},{default:l(()=>[t(R,null,{default:l(()=>[t(Y(ne))]),_:1}),e[13]||(e[13]=D(" 导出报告 ",-1))]),_:1})])]),default:l(()=>[De((b(),B(se,{data:S.value,stripe:"",style:{width:"100%"}},{default:l(()=>[t(f,{prop:"deviceId",label:"设备ID",width:"150"}),t(f,{prop:"username",label:"驾驶员",width:"120"}),t(f,{prop:"totalEvents",label:"总事件数",width:"100"}),t(f,{prop:"fatigueEvents",label:"疲劳事件",width:"100"}),t(f,{prop:"distractionEvents",label:"分心事件",width:"100"}),t(f,{prop:"totalDrivingTime",label:"驾驶时长",width:"120"},{default:l(({row:r})=>[D(v(ae(r.totalDrivingTime)),1)]),_:1}),t(f,{prop:"totalDistance",label:"行驶距离",width:"100"},{default:l(({row:r})=>[D(v(r.totalDistance)+" km ",1)]),_:1}),t(f,{prop:"averageSpeed",label:"平均速度",width:"100"},{default:l(({row:r})=>[D(v(r.averageSpeed)+" km/h ",1)]),_:1}),t(f,{prop:"safetyScore",label:"安全评分",width:"100"},{default:l(({row:r})=>[t(z,{type:te(r.safetyScore),size:"small"},{default:l(()=>[D(v(r.safetyScore)+"分 ",1)]),_:2},1032,["type"])]),_:1}),t(f,{prop:"riskLevel",label:"风险等级",width:"100"},{default:l(({row:r})=>[t(z,{type:ee(r.riskLevel),size:"small"},{default:l(()=>[D(v(Z(r.riskLevel)),1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data"])),[[le,w.value]])]),_:1})])}}},lt=J(Ze,[["__scopeId","data-v-6a628ed4"]]);export{lt as default};
