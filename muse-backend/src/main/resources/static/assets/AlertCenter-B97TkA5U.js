import{r as y,c as de,h as ie,U as ue,z as O,A as w,B as s,R as e,I as D,L as E,J as t,O as o,al as u,u as c,P as n,K as ce,ar as _e,W as T}from"./vendor-BleAlWPf.js";import{r as ve,x as pe,b as fe,w as me,y as ge,z as be,E as g,A as he}from"./element-DCn9y4rn.js";import{_ as we,u as Ie,w as F}from"./index-D7UZbDsL.js";import"./charts-TxDtCNV3.js";const ye={class:"alert-center"},Ce={class:"page-header"},Ae={class:"header-actions"},ke={class:"stat-content"},Me={class:"stat-icon"},xe={class:"stat-info"},De={class:"stat-value"},Ee={class:"stat-content"},Te={class:"stat-icon"},Ve={class:"stat-info"},Re={class:"stat-value"},He={class:"stat-content"},Ne={class:"stat-icon"},Se={class:"stat-info"},Ue={class:"stat-value"},Le={class:"stat-content"},Ge={class:"stat-icon"},ze={class:"stat-info"},Oe={class:"stat-value"},Fe={class:"card-header"},Be={class:"header-actions"},$e={class:"alert-handle-content"},We={class:"alert-info"},Ye={class:"handle-actions"},Je={key:0,class:"alert-detail"},Ke={__name:"AlertCenter",setup(Pe){const _=Ie(),C=y("all"),r=y(null),A=y(!1),v=y({action:"",note:""}),B=de(()=>{let a=_.realtimeAlerts;switch(C.value){case"active":return a.filter(l=>l.status==="ACTIVE");case"acknowledged":return a.filter(l=>l.acknowledged);case"critical":return a.filter(l=>l.severity==="CRITICAL");default:return a}}),k=async()=>{try{await _.fetchRealtimeAlerts()}catch(a){console.error("加载告警列表失败:",a),g.error("加载告警列表失败")}},$=()=>{k()},W=async()=>{try{await he.confirm("确认清空所有已处理的告警？","确认操作",{type:"warning"}),g.success("已清空已处理的告警")}catch{}},Y=()=>{},J=a=>{r.value=a},K=async a=>{try{await _.acknowledgeAlert(a.alertId),g.success("告警已确认")}catch(l){console.error("确认告警失败:",l),g.error("确认告警失败")}},P=a=>{r.value=a,v.value={action:"",note:""}},j=a=>{r.value=a,A.value=!0},q=async()=>{if(!v.value.action){g.warning("请选择处理方式");return}try{await _.handleAlert(r.value.alertId,v.value),g.success("告警处理完成"),r.value=null,v.value={action:"",note:""}}catch(a){console.error("处理告警失败:",a),g.error("处理告警失败")}},Q=()=>{r.value=null,v.value={action:"",note:""}},M=a=>a?new Date(a).toLocaleString():"未知",V=a=>a?`${a.lat.toFixed(6)}, ${a.lng.toFixed(6)}`:"未知",R=a=>({LOW:"轻微",MEDIUM:"中等",HIGH:"严重",CRITICAL:"危急"})[a]||"未知",X=a=>({LOW:"success",MEDIUM:"warning",HIGH:"danger",CRITICAL:"danger"})[a]||"info",H=a=>({FATIGUE_HIGH:"疲劳严重",FATIGUE_MEDIUM:"疲劳中等",DISTRACTION_HIGH:"分心严重",DISTRACTION_MEDIUM:"分心中等",EMERGENCY:"紧急事件",SYSTEM_ERROR:"系统错误"})[a]||a,N=a=>({ACTIVE:"活跃",HANDLED:"已处理",IGNORED:"已忽略"})[a]||"未知",Z=a=>({ACTIVE:"danger",HANDLED:"success",IGNORED:"info"})[a]||"info",S=a=>{_.addAlert(a),ee(a.severity),te(a)},ee=a=>{const l=new Audio;a==="CRITICAL"||a==="HIGH"?l.src="/static/audio/alert_high.mp3":a==="MEDIUM"?l.src="/static/audio/alert_mid.mp3":l.src="/static/audio/alert_low.mp3",l.play().catch(p=>console.log("无法播放告警声音:",p))},te=a=>{g({message:`新告警: ${a.message}`,type:"warning",duration:5e3,showClose:!0})};return ie(()=>{k(),F.on("alert",S);const a=setInterval(()=>{k()},3e4);ue(()=>{clearInterval(a),F.off("alert",S)})}),(a,l)=>{const p=u("el-icon"),b=u("el-button"),h=u("el-card"),I=u("el-col"),le=u("el-row"),f=u("el-option"),U=u("el-select"),L=u("el-tag"),m=u("el-table-column"),ae=u("el-table"),i=u("el-descriptions-item"),G=u("el-descriptions"),x=u("el-form-item"),se=u("el-input"),oe=u("el-form"),ne=u("el-dialog"),re=_e("loading");return w(),O("div",ye,[s("div",Ce,[l[6]||(l[6]=s("h2",null,"告警中心",-1)),s("div",Ae,[e(b,{onClick:$},{default:t(()=>[e(p,null,{default:t(()=>[e(c(ve))]),_:1}),l[4]||(l[4]=o(" 刷新 ",-1))]),_:1}),e(b,{onClick:W,type:"danger"},{default:t(()=>[e(p,null,{default:t(()=>[e(c(pe))]),_:1}),l[5]||(l[5]=o(" 清空已处理 ",-1))]),_:1})])]),e(le,{gutter:20,class:"alert-stats"},{default:t(()=>[e(I,{xs:12,sm:6,md:6,lg:6,xl:6},{default:t(()=>[e(h,{class:"stat-card active"},{default:t(()=>[s("div",ke,[s("div",Me,[e(p,null,{default:t(()=>[e(c(fe))]),_:1})]),s("div",xe,[s("div",De,n(c(_).alertCount.active),1),l[7]||(l[7]=s("div",{class:"stat-label"},"活跃告警",-1))])])]),_:1})]),_:1}),e(I,{xs:12,sm:6,md:6,lg:6,xl:6},{default:t(()=>[e(h,{class:"stat-card critical"},{default:t(()=>[s("div",Ee,[s("div",Te,[e(p,null,{default:t(()=>[e(c(me))]),_:1})]),s("div",Ve,[s("div",Re,n(c(_).alertCount.critical),1),l[8]||(l[8]=s("div",{class:"stat-label"},"严重告警",-1))])])]),_:1})]),_:1}),e(I,{xs:12,sm:6,md:6,lg:6,xl:6},{default:t(()=>[e(h,{class:"stat-card acknowledged"},{default:t(()=>[s("div",He,[s("div",Ne,[e(p,null,{default:t(()=>[e(c(ge))]),_:1})]),s("div",Se,[s("div",Ue,n(c(_).alertCount.acknowledged),1),l[9]||(l[9]=s("div",{class:"stat-label"},"已确认",-1))])])]),_:1})]),_:1}),e(I,{xs:12,sm:6,md:6,lg:6,xl:6},{default:t(()=>[e(h,{class:"stat-card total"},{default:t(()=>[s("div",Le,[s("div",Ge,[e(p,null,{default:t(()=>[e(c(be))]),_:1})]),s("div",ze,[s("div",Oe,n(c(_).alertCount.total),1),l[10]||(l[10]=s("div",{class:"stat-label"},"总告警数",-1))])])]),_:1})]),_:1})]),_:1}),e(h,{class:"alert-list-section",shadow:"hover"},{header:t(()=>[s("div",Fe,[l[11]||(l[11]=s("span",null,"实时告警列表",-1)),s("div",Be,[e(U,{modelValue:C.value,"onUpdate:modelValue":l[0]||(l[0]=d=>C.value=d),onChange:Y,size:"small",style:{width:"150px"}},{default:t(()=>[e(f,{label:"全部",value:"all"}),e(f,{label:"活跃",value:"active"}),e(f,{label:"已确认",value:"acknowledged"}),e(f,{label:"严重",value:"critical"})]),_:1},8,["modelValue"])])])]),default:t(()=>[ce((w(),D(ae,{data:B.value,stripe:"",style:{width:"100%"},onRowClick:J},{default:t(()=>[e(m,{prop:"severity",label:"严重程度",width:"100"},{default:t(({row:d})=>[e(L,{type:X(d.severity),size:"small"},{default:t(()=>[o(n(R(d.severity)),1)]),_:2},1032,["type"])]),_:1}),e(m,{prop:"timestamp",label:"时间",width:"180"},{default:t(({row:d})=>[o(n(M(d.timestamp)),1)]),_:1}),e(m,{prop:"deviceId",label:"设备ID",width:"150"}),e(m,{prop:"username",label:"驾驶员",width:"120"},{default:t(({row:d})=>[o(n(d.user?.username||"未知"),1)]),_:1}),e(m,{prop:"alertType",label:"告警类型",width:"150"},{default:t(({row:d})=>[o(n(H(d.alertType)),1)]),_:1}),e(m,{prop:"message",label:"告警信息","min-width":"200","show-overflow-tooltip":""}),e(m,{prop:"status",label:"状态",width:"100"},{default:t(({row:d})=>[e(L,{type:Z(d.status),size:"small"},{default:t(()=>[o(n(N(d.status)),1)]),_:2},1032,["type"])]),_:1}),e(m,{label:"操作",width:"200",fixed:"right"},{default:t(({row:d})=>[d.acknowledged?E("",!0):(w(),D(b,{key:0,size:"small",type:"primary",onClick:T(z=>K(d),["stop"])},{default:t(()=>[...l[12]||(l[12]=[o(" 确认 ",-1)])]),_:1},8,["onClick"])),e(b,{size:"small",type:"success",onClick:T(z=>P(d),["stop"])},{default:t(()=>[...l[13]||(l[13]=[o(" 处理 ",-1)])]),_:1},8,["onClick"]),e(b,{size:"small",onClick:T(z=>j(d),["stop"])},{default:t(()=>[...l[14]||(l[14]=[o(" 详情 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[re,c(_).loading]])]),_:1}),r.value?(w(),D(h,{key:0,class:"alert-handle-section",shadow:"hover"},{header:t(()=>[...l[15]||(l[15]=[s("span",null,"告警处理",-1)])]),default:t(()=>[s("div",$e,[s("div",We,[s("h4",null,n(r.value.message),1),e(G,{column:2,border:"",size:"small"},{default:t(()=>[e(i,{label:"告警ID"},{default:t(()=>[o(n(r.value.alertId),1)]),_:1}),e(i,{label:"设备"},{default:t(()=>[o(n(r.value.deviceId)+" ("+n(r.value.user?.username)+")",1)]),_:1}),e(i,{label:"时间"},{default:t(()=>[o(n(M(r.value.timestamp)),1)]),_:1}),e(i,{label:"位置"},{default:t(()=>[o(n(V(r.value.location)),1)]),_:1}),e(i,{label:"详情",span:2},{default:t(()=>[o(n(r.value.message),1)]),_:1})]),_:1})]),s("div",Ye,[e(oe,{model:v.value,"label-width":"80px"},{default:t(()=>[e(x,{label:"处理方式"},{default:t(()=>[e(U,{modelValue:v.value.action,"onUpdate:modelValue":l[1]||(l[1]=d=>v.value.action=d),placeholder:"选择处理方式"},{default:t(()=>[e(f,{label:"电话联系",value:"call"}),e(f,{label:"短信通知",value:"sms"}),e(f,{label:"现场处理",value:"onsite"}),e(f,{label:"忽略告警",value:"ignore"})]),_:1},8,["modelValue"])]),_:1}),e(x,{label:"处理备注"},{default:t(()=>[e(se,{modelValue:v.value.note,"onUpdate:modelValue":l[2]||(l[2]=d=>v.value.note=d),type:"textarea",placeholder:"请输入处理备注",rows:3},null,8,["modelValue"])]),_:1}),e(x,null,{default:t(()=>[e(b,{type:"primary",onClick:q},{default:t(()=>[...l[16]||(l[16]=[o("提交处理",-1)])]),_:1}),e(b,{onClick:Q},{default:t(()=>[...l[17]||(l[17]=[o("取消",-1)])]),_:1})]),_:1})]),_:1},8,["model"])])])]),_:1})):E("",!0),e(ne,{modelValue:A.value,"onUpdate:modelValue":l[3]||(l[3]=d=>A.value=d),title:"告警详情",width:"600px"},{default:t(()=>[r.value?(w(),O("div",Je,[e(G,{column:2,border:""},{default:t(()=>[e(i,{label:"告警ID"},{default:t(()=>[o(n(r.value.alertId),1)]),_:1}),e(i,{label:"设备ID"},{default:t(()=>[o(n(r.value.deviceId),1)]),_:1}),e(i,{label:"驾驶员"},{default:t(()=>[o(n(r.value.user?.username||"未知"),1)]),_:1}),e(i,{label:"联系方式"},{default:t(()=>[o(n(r.value.user?.phone||"未知"),1)]),_:1}),e(i,{label:"告警类型"},{default:t(()=>[o(n(H(r.value.alertType)),1)]),_:1}),e(i,{label:"严重程度"},{default:t(()=>[o(n(R(r.value.severity)),1)]),_:1}),e(i,{label:"状态"},{default:t(()=>[o(n(N(r.value.status)),1)]),_:1}),e(i,{label:"确认状态"},{default:t(()=>[o(n(r.value.acknowledged?"已确认":"未确认"),1)]),_:1}),e(i,{label:"发生时间",span:2},{default:t(()=>[o(n(M(r.value.timestamp)),1)]),_:1}),e(i,{label:"位置",span:2},{default:t(()=>[o(n(V(r.value.location)),1)]),_:1}),e(i,{label:"告警信息",span:2},{default:t(()=>[o(n(r.value.message),1)]),_:1})]),_:1})])):E("",!0)]),_:1},8,["modelValue"])])}}},Ze=we(Ke,[["__scopeId","data-v-033f1eae"]]);export{Ze as default};
