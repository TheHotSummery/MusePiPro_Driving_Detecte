# 疲劳驾驶与分级预警及监测系统 - 部署说明

本文档提供 Muse Pi Pro 疲劳驾驶监测系统的完整部署指南，涵盖硬件端、PLC 控制系统和后端服务三个核心组件的部署步骤。

## 目录

- [一、系统概述](#一系统概述)
- [二、环境要求](#二环境要求)
- [三、部署步骤](#三部署步骤)
  - [3.1 PLC 控制系统部署（必须）](#31-plc-控制系统部署必须)
  - [3.2 硬件端部署（核心）](#32-硬件端部署核心)
  - [3.3 数据库部署（可选）](#33-数据库部署可选)
  - [3.4 后端服务部署（可选）](#34-后端服务部署可选)
- [四、系统启动顺序](#四系统启动顺序)
- [五、验证与测试](#五验证与测试)
- [六、故障排除](#六故障排除)
- [七、维护与监控](#七维护与监控)

---

## 一、系统概述

Muse Pi Pro 疲劳驾驶监测系统是一个完整的端到端解决方案，包括：

- **硬件端 (muse-hardware)**：基于 YOLOv8 的实时疲劳检测，运行在 Muse Pi Pro 开发板上
- **PLC 控制系统 (plc_cpp)**：C++ 实现的简易 PLC，控制 GPIO 输出和硬件联动
- **后端服务 (muse-backendv2)**：Spring Boot 后端服务，处理数据上报、存储和展示

### 系统工作流程

```
硬件端 (muse-hardware)
    ↓ (检测疲劳行为)
    ↓ (通过 Modbus TCP)
PLC 控制系统 (plc_cpp)
    ↓ (控制 GPIO 输出)
    ↓ (LED/振动/蜂鸣器)
硬件预警
    ↓ (数据上报)
后端服务 (muse-backendv2)
    ↓ (数据存储和分析)
前端展示 (muse-adminpanelv2)
```

### 部署架构图





![architecture](.\assets\architecture.JPG)

**说明**：
- 硬件端与 PLC 系统通过 Modbus TCP 通信（端口 502）
- 硬件端通过 HTTP 协议上报数据到后端服务（端口 8081）
- 前端管理面板通过 API 接口访问后端服务

---

## 二、环境要求

### 2.1 硬件建议

- **Muse Pi Pro 开发板** (RISC-V)
  - CPU: 8 核
  - NPU: SpaceMIT K1
  - 存储: 至少16GB eMMC
  - 操作系统: Bianbu (基于 Linux)

- **外设**
  - USB 摄像头 (设备索引: /dev/video20)
  - Quectel EC800M 4G 模块 (可选)
  - GPIO 驱动板（必须，否则 GPIO 无法驱动）

### 2.2 软件要求

| 组件 | 必需性 | 软件要求 |
|------|--------|----------|
| **硬件端** | ✅ 必须 | Python 3.8+、SpaceMIT NPU 驱动、lgpio、libgpiod 系统库 |
| **PLC 控制系统** | ✅ 必须 | C++17 编译器、CMake 3.10+、libgpiod-dev、libmodbus-dev |
| **后端服务** | ⚠️ 可选 | Java 17+、Maven 3.6+、MySQL 8.0+ |
| **数据库** | ⚠️ 可选 | MySQL 8.0+、字符集: utf8mb4 |

**注意**：后端服务和数据库为可选组件，不影响硬件端的正常运行。如果需要数据上报和存储功能，则需要部署后端服务。

---

## 三、部署步骤

### 3.1 PLC 控制系统部署（必须）

PLC 控制系统独立于视觉识别部分,主要负责 GPIO 输出控制，是硬件预警功能的核心组件。**如果不部署 PLC 系统，将无法看到 GPIO 输出效果。**

#### 3.1.1 进入项目目录

```bash
cd plc_cpp
```

#### 3.1.2 安装依赖

```bash
sudo apt-get update
sudo apt-get install -y build-essential cmake libgpiod-dev libmodbus-dev pkg-config
```

#### 3.1.3 编译 PLC 系统

```bash
mkdir -p build
cd build
cmake ..
make
```

编译成功后，可执行文件位于 `build/plc_core`

![3.1.3](.\assets\3.1.3.png)

#### 3.1.4 配置 PLC

编辑配置文件（按优先级）：
1. `/home/hyit/plc/plc_config.json` （默认，可通过修改源代码更改）
2. `config/plc_config.json` （本地）

配置文件示例：

```json
{
  "ladder_diagrams": [
    {
      "name": "YOLO Level 1",
      "conditions": [{"type": "coil", "address": 40}],
      "outputs": [{"type": "output", "address": 0}]
    }
  ]
}
```

**提示**：若编写配置文件困难，项目目录下配套有 `plc配置文件生成器.html` 可以进行可视化编写。

![3.1.4](.\assets\3.1.4.png)

#### 3.1.5 GPIO 连接对照表

| GPIO 引脚 | 功能说明 |
|-----------|----------|
| GPIO35 | Q0（调试用呼吸灯） |
| GPIO46 | Q1 |
| GPIO37 | Q2 |
| GPIO71 | Q3（震动马达） |
| GPIO72 | Q4（LED） |
| GPIO73 | Q5（蜂鸣器） |
| GPIO74 | IN1（可选接npn光电传感器，有人时候启动） |
| GPIO91 | IN2 |
| GPIO92 | IN3 |
| GPIO33 | 总继电器使能 |
| GPIO51 | 指示灯 |
| UART0_TXD | 有线串口调试 |
| UART0_RXD | 有线串口调试 |

**重要提示**：系统采用机械继电器控制总输出（高电平默认关闭，低电平触发），MOSFET 作为六路分控制（高电平触发）。开机瞬间继电器会断开，断开输出。必须等到 PLC 就绪（约 2 分钟），才会主动拉低 GPIO，同时继电器吸合。

实物连接图，由于主板固定在了外壳上，拍摄略有困难，所以采用绘制的方法。

![3.1.5](.\assets\3.1.5.png)



#### 3.1.6 运行 PLC 系统


端口 502 可能无法绑定，先运行：

```bash
sudo setcap 'cap_net_bind_service=+ep' ./build/plc_core
```

```bash
# 需要 root 权限（GPIO 访问）
cd build
sudo ./plc_core

# 或指定配置文件
sudo ./plc_core /home/hyit/plc/plc_config.json
```

![3.1.6](D:\HP\Desktop\Muse Pi Pro\assets\3.1.6.png)

注意：当前plc进程运行在前端，如果关闭命令行会导致进程也被关闭，正确做法是配置系统服务或者挂到后台运行，避免被杀死。

#### 3.1.7 配置开机自启（可选）

创建 systemd 服务文件：

```bash
sudo nano /etc/systemd/system/plc-core.service
```

服务配置（**请替换为您的实际路径**）：

```ini
[Unit]
Description=PLC Core Application
After=network.target
Wants=network.target

[Service]
Type=simple
User=YOUR_USER
WorkingDirectory=/path/to/plc_cpp/build
ExecStart=/path/to/plc_cpp/build/plc_core
Restart=on-failure
RestartSec=5
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```



![3.1.7](.\assets\3.1.7.png)启动服务：

```bash
sudo systemctl daemon-reload
sudo systemctl enable plc-core.service
sudo systemctl start plc-core.service
```

#### 3.1.8 验证 PLC 系统

```bash
# 检查进程
ps aux | grep plc_core

# 检查 Modbus 端口
sudo netstat -tlnp | grep 502

# 查看日志
sudo journalctl -u plc-core.service -f
```

---

### 3.2 硬件端部署（核心）

硬件端是系统的核心部分，包含图像采集、PLC 通信、数据上报和存储功能。

#### 3.2.1 安装系统依赖

```bash
sudo apt-get update
sudo apt-get install -y python3-pip python3-dev libgpiod-dev
```

#### 3.2.2 安装 Python 依赖

```bash
cd muse-hardware
```

**注意**：建议使用虚拟环境：

```bash
python -m venv yolo_env
source yolo_env/bin/activate
pip install -r requirements.txt

```

创建虚拟环境并且安装依赖：

![安装并且激活虚拟环境然后安装 requirements.txt](.\assets\3.2.2.png)

#### 3.2.3 配置硬件端

编辑 `config.py`:

```python
# 摄像头配置
CAMERA_CONFIG = {
    "device_index": 20  # 此款为usb摄像头，请根据实际设备调整，默认就是20，可通过 v4l2-ctl --list-devices 查看
}

# 网络模块配置（如果没有 EC800M，可以禁用,默认提供的就是禁用的）
NETWORK_MODULE_CONFIG = {
    "enabled": False,      # 如果禁用，设置为 False
    "skip_gnss": True,   # 是否跳过 GPS 初始化
    "skip_ntp": True,    # 是否跳过 NTP 时间同步
    "skip_login": True   # 是否跳过设备登录
}
```

编辑 `network_config.json`:

```json
{
  "device_id": "MUSE_PI_PRO_001",
  "backend_url": "http://YOUR_BACKEND_IP:8080",
  "serial_port": "/dev/ttyUSB2",
  "baud_rate": 115200
}
```

**提示**：如果不知道设备 IP，可以运行 `ifconfig` 查看。

#### 3.2.4 运行硬件端（请先运行plc端）

```bash
# 普通模式
python3 start.py

# 调试模式（带日志）
python3 start.py --debug
```

![3.2.4]( .\assets\3.2.4.png)



#### 3.2.5 配置开机自启（可选）

创建 systemd 服务文件：

```bash
sudo nano /etc/systemd/system/musepiproplus.service
```

服务配置（**请替换为您的实际路径**）：

```ini
[Unit]
Description=Muse Pi Pro Plus YOLO Service
After=network-online.target
Wants=network-online.target

[Service]
User=YOUR_USER
WorkingDirectory=/path/to/muse-hardware
Environment="PYTHONUNBUFFERED=1"
ExecStart=/bin/bash -lc 'source /path/to/muse-hardware/yolo_env/bin/activate && python start.py'
Restart=on-failure
RestartSec=5
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

启动服务：

```bash
sudo systemctl daemon-reload
sudo systemctl enable musepiproplus.service
sudo systemctl start musepiproplus.service
```

#### 3.2.6 验证硬件端

```bash
# 检查服务状态
sudo systemctl status musepiproplus.service

# 访问 Web 界面
# 浏览器打开: http://YOUR_DEVICE_IP:5200

# 查看日志
sudo journalctl -u musepiproplus.service -f
```

---

### 3.3 数据库部署（可选）

数据库部署为可选步骤，不影响硬件端的正常运行。如果需要后端接收数据，则需要部署数据库和后端。

#### 3.3.1 安装 MySQL

```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install mysql-server

# 启动 MySQL
sudo systemctl start mysql
sudo systemctl enable mysql
```

#### 3.3.2 创建数据库和用户

```bash
# 登录 MySQL
sudo mysql -u root -p

# 创建数据库
CREATE DATABASE muse_v2 CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 创建用户（替换密码）
CREATE USER 'muse_v2'@'%' IDENTIFIED BY 'YOUR_PASSWORD';
GRANT ALL PRIVILEGES ON muse_v2.* TO 'muse_v2'@'%';
FLUSH PRIVILEGES;
EXIT;
```

#### 3.3.3 导入数据库结构

```bash
# SQL 初始化脚本位于 muse-backendv2 目录
cd muse-backendv2
mysql -u muse_v2 -p muse_v2 < init_v2.sql
```

#### 3.3.4 验证数据库

```bash
mysql -u muse_v2 -p muse_v2 -e "SHOW TABLES;"
```

---

### 3.4 后端服务部署（可选）

后端服务部署为可选步骤，不影响硬件端的正常运行。如果需要后端接收数据，则需要部署后端服务。

前端文件已经打包放入static文件夹，可以直接编译后端使用。

#### 3.4.1 安装 Java 和 Maven

```bash
# 安装 Java 17
sudo apt-get install openjdk-17-jdk

# 验证 Java 版本
java -version

# 安装 Maven
sudo apt-get install maven

# 验证 Maven 版本
mvn -version
```

#### 3.4.2 配置数据库连接

编辑 `muse-backendv2/src/main/resources/application.properties`:

```properties
# 数据库配置
spring.datasource.url=jdbc:mysql://YOUR_DB_HOST:3306/muse_v2?useSSL=false&serverTimezone=UTC&characterEncoding=utf8&allowPublicKeyRetrieval=true
spring.datasource.username=muse_v2
spring.datasource.password=YOUR_PASSWORD

# JWT 配置（生产环境请修改密钥）
jwt.secret=YOUR_SECRET_KEY
jwt.expiration=86400000

# 高德地图 API 配置（可选，需要去高德开放平台申请  https://console.amap.com/dev/key/app）
amap.api.key=YOUR_AMAP_KEY
amap.api.secret=YOUR_AMAP_SECRET
```

关于api key的申请：https://console.amap.com/dev/key/app

![3.4.2](.\assets\3.4.2.png)





#### 3.4.3 编译项目

```bash
cd muse-backendv2
mvn clean package -DskipTests
```

#### 3.4.4 运行服务

```bash
# 方式一：直接运行 JAR
java -jar target/muse-backendv2-0.0.1-SNAPSHOT.jar

# 方式二：使用 systemd 服务
sudo nano /etc/systemd/system/muse-backendv2.service
```

systemd 服务配置（**请替换为您的实际路径**）：

```ini
[Unit]
Description=Muse Backend V2 Service
After=network.target mysql.service
Wants=network.target

[Service]
Type=simple
User=YOUR_USER
WorkingDirectory=/path/to/muse-backendv2
ExecStart=/usr/bin/java -jar /path/to/muse-backendv2/target/muse-backendv2-0.0.1-SNAPSHOT.jar
Restart=on-failure
RestartSec=5
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

启动服务：

```bash
sudo systemctl daemon-reload
sudo systemctl enable muse-backendv2.service
sudo systemctl start muse-backendv2.service
sudo systemctl status muse-backendv2.service
```

#### 3.4.5 验证后端服务

```bash
# 检查服务状态
curl http://localhost:8080/api/v2/auth/token?deviceId=TEST_DEVICE

# 查看日志
sudo journalctl -u muse-backendv2.service -f
```

---

## 四、系统启动顺序

若您需要体验完整的系统运行，为确保系统正常运行，建议按以下顺序启动：

1. **数据库服务**（如果部署了后端）
   ```bash
   sudo systemctl start mysql
   ```

2. **后端服务**（如果部署了后端）
   ```bash
   sudo systemctl start muse-backendv2.service
   ```

3. **PLC 控制系统**（必须）
   ```bash
   sudo systemctl start plc-core.service
   ```
   **大概几秒钟**，直到 PLC 就绪（指示灯快闪）

4. **硬件端**（必须）
   
   ```bash
   sudo systemctl start musepiproplus.service
   ```
   **等待约 半 分钟**，直到 YOLO 就绪（指示灯慢闪）

### 启动状态指示

系统通过指示灯显示运行状态：

| 状态 | 指示灯状态 | 说明 |
|------|-----------|------|
| 系统上电开机 | 常亮 | 系统刚启动 |
| PLC 就绪 | 快闪 | 约 2 分钟后，PLC 系统已就绪 |
| YOLO 就绪 | 慢闪 | 再约 1 分钟后，系统正常工作 |



---

## 五、验证与测试

### 5.1 后端服务测试（如果部署了后端）

```bash
# 测试 Token 获取接口
curl -X POST "http://localhost:8080/api/v2/auth/token?deviceId=TEST_DEVICE"

# 测试数据上报接口（测试模式）
curl -X POST "http://localhost:8080/api/v2/data/report?device_id=TEST_DEVICE" \
  -H "Content-Type: application/json" \
  -d '{
    "dataType": "status",
    "timestamp": 1705123456789,
    "data": {
      "level": "Normal",
      "score": 45.2
    }
  }'
```

### 5.2 PLC 系统测试

```bash
# 检查 Modbus 连接
sudo netstat -tlnp | grep 502

# 使用 modbus 客户端测试（需要安装）
modbus read 127.0.0.1 502 0 1
```

### 5.3 硬件端测试

```bash
# 访问 Web 界面
# http://YOUR_DEVICE_IP:5200

# 检查视频流
curl http://YOUR_DEVICE_IP:5200/feed/webcam/

# 检查系统状态
curl http://YOUR_DEVICE_IP:5200/status
```

### 5.4 端到端测试

1. **硬件端检测到疲劳行为**
   - 观察 Web 界面是否显示检测结果
   - 检查疲劳等级是否正确

2. **PLC 联动测试**
   - 当疲劳等级达到 Level 1/2/3 时
   - 检查 GPIO 输出是否正确（LED/振动/蜂鸣器）

3. **数据上报测试**（如果部署了后端）
   - 检查后端服务是否收到数据
   - 查看数据库是否写入数据

---

## 六、故障排除

### 6.1 数据库连接失败

**问题**：后端服务无法连接数据库

**解决方案**：
- 检查 MySQL 服务是否运行：`sudo systemctl status mysql`
- 检查数据库用户权限
- 检查防火墙设置
- 查看后端服务日志：`sudo journalctl -u muse-backendv2.service -f`

### 6.2 PLC Modbus 连接失败

**问题**：硬件端无法连接 PLC

**解决方案**：
- 检查 PLC 服务是否运行：`sudo systemctl status plc-core.service`
- 检查端口 502 是否被占用：`sudo netstat -tlnp | grep 502`
- 检查防火墙设置
- 查看 PLC 日志：`sudo journalctl -u plc-core.service -f`

### 6.3 硬件端摄像头无法打开

**问题**：摄像头初始化失败

**解决方案**：
- 检查摄像头设备索引：`v4l2-ctl --list-devices`
- 检查设备权限：`ls -l /dev/video20`
- 修改 `config.py` 中的 `device_index`

### 6.4 数据上报失败

**问题**：硬件端无法上报数据到后端

**解决方案**：
- 检查网络连接
- 检查后端服务地址和端口
- 检查设备 ID 配置
- 使用测试模式：`?device_id=YOUR_DEVICE_ID`
- 查看网络管理器日志

### 6.5 GPIO 控制失败

**问题**：PLC 无法控制 GPIO

**解决方案**：
- 检查 GPIO 权限：`ls -l /dev/gpiochip*`
- 检查用户是否在 gpio 组中
- 检查 GPIO 连接是否正确
- 检查 GPIO 驱动板是否连接
- 查看 PLC 日志

---

## 七、维护与监控

### 7.1 日志管理

**后端服务日志**（如果部署了后端）：
```bash
sudo journalctl -u muse-backendv2.service -f
```

**PLC 系统日志**：
```bash
sudo journalctl -u plc-core.service -f
```

**硬件端日志**：
```bash
# 应用日志
tail -f muse-hardware/app_log.txt

# 性能监控日志
tail -f muse-hardware/performance_logs/performance_*.log

# systemd 日志
sudo journalctl -u musepiproplus.service -f
```

### 7.2 性能监控

**硬件端性能监控**：
- 启用性能监控：编辑 `config.py`，设置 `PERFORMANCE_MONITOR_CONFIG["enabled"] = True`
- 查看性能日志：`tail -f performance_logs/performance_*.log`

**系统资源监控**：
```bash
# CPU 和内存
htop

# 磁盘使用
df -h

# 网络连接
netstat -an | grep ESTABLISHED
```

### 7.3 数据库维护（如果部署了后端）

**定期备份**：
```bash
# 备份数据库
mysqldump -u muse_v2 -p muse_v2 > backup_$(date +%Y%m%d).sql

# 恢复数据库
mysql -u muse_v2 -p muse_v2 < backup_20250115.sql
```

**清理旧数据**（可选）：
```sql
-- 清理 30 天前的状态数据
DELETE FROM status_data WHERE timestamp < UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 30 DAY)) * 1000;

-- 清理 90 天前的事件数据
DELETE FROM event_data WHERE timestamp < UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 90 DAY)) * 1000;
```

### 7.4 服务管理

**查看所有服务状态**：
```bash
sudo systemctl status muse-backendv2.service  # 如果部署了后端
sudo systemctl status plc-core.service
sudo systemctl status musepiproplus.service
```

**重启服务**：
```bash
sudo systemctl restart muse-backendv2.service  # 如果部署了后端
sudo systemctl restart plc-core.service
sudo systemctl restart musepiproplus.service
```

**停止服务**：
```bash
sudo systemctl stop muse-backendv2.service  # 如果部署了后端
sudo systemctl stop plc-core.service
sudo systemctl stop musepiproplus.service
```

---

## 相关文档

若对某个方面有疑问，优先参考对应的详细文档：

- **硬件端文档**：`muse-hardware/README.md`
- **PLC 系统文档**：`plc_cpp/README.md`
- **后端服务文档**：`muse-backendv2/README.md`
- **API 接口规范**：`muse-hardware/HARDWARE_DATA_API_SPECIFICATION-确定稿.md`
- **数据库设计**：`muse-backendv2/V2_DATABASE_DESIGN.md`

---

## 版本信息

- **文档版本**：v1.0
- **最后更新**：2025-12-06
- **适用系统版本**：
  - 硬件端：v2.0
  - PLC 系统：v2.0
  - 后端服务：v2.0

---

## 联系方式

如有问题或建议，请联系：

- **项目地址**：https://gitee.com/achenjiayi/MusePiPro_Driving_Detecte
- **Issues**：https://gitee.com/achenjiayi/MusePiPro_Driving_Detecte/issues
- **邮箱**：zhangyile577@qq.com

---

**注意**：本文档会持续更新，请定期查看最新版本。
