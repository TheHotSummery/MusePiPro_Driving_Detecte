# Muse Pi Pro 疲劳驾驶监测系统 - 部署指南

本文档提供 Muse Pi Pro 疲劳驾驶监测系统的完整部署指南，涵盖硬件端、PLC 控制系统和后端服务三个核心组件的部署步骤。

##  目录

- [系统概述](#系统概述)
- [部署架构](#部署架构)
- [环境要求](#环境要求)
- [部署步骤](#部署步骤)

  - [1. PLC 控制系统部署](#3-plc-控制系统部署)
  - [2. 硬件端部署](#4-硬件端部署)
  - [3. 数据库部署](#1-数据库部署)
  - [4. 后端服务部署](#2-后端服务部署)
- [系统启动顺序](#系统启动顺序)
- [验证与测试](#验证与测试)
- [故障排除](#故障排除)
- [维护与监控](#维护与监控)

---

## 系统概述

Muse Pi Pro 疲劳驾驶监测系统是一个完整的端到端解决方案，包括：

- **硬件端 (muse-hardware)**：基于 YOLOv8 的实时疲劳检测，运行在 Muse Pi Pro 开发板上
- **PLC 控制系统 (plc_cpp)**：C++ 实现的简易 PLC，控制 GPIO 输出和硬件联动
- **后端服务 (muse-backendv2)**：Spring Boot 后端服务，处理数据上报、存储和展示

### 系统工作流程

```
硬件端 (muse-hardware)
    ↓ (检测疲劳行为)
    ↓ (通过 Modbus TCP)
PLC 控制系统 (plc_cpp)
    ↓ (控制 GPIO 输出)
    ↓ (LED/振动/蜂鸣器)
硬件预警
    ↓ (数据上报)
后端服务 (muse-backendv2)
    ↓ (数据存储和分析)
前端展示 (muse-adminpanelv2)
```

---

## 部署架构

```
┌─────────────────────────────────────────────────────────┐
│                    部署架构图                            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌──────────────┐      ┌──────────────┐                │
│  │  硬件端       │      │  PLC 系统     │               │
│  │muse-hardware │◄────►│  plc_cpp     │                │
│  │  (Python)    │Modbus│  (C++)       │                │
│  │  Port: 5200  │ TCP  │  Port: 502   │                │
│  └──────────────┘      └──────────────┘                │
│         │                      │                       │
│         │ 数据上报              │ GPIO 控制             │
│         ▼                      ▼                       │
│  ┌──────────────────────────────────────┐              │
│  │      后端服务 (muse-backendv2)        │              │
│  │      Spring Boot + MySQL              │              │
│  │      Port: 8080                       │              │
│  └──────────────────────────────────────┘              │
│         │                                              │
│         │ API 接口                                      │
│         ▼                                              │
│  ┌──────────────┐                                      │
│  │  前端管理面板  │                                     │
│  │muse-adminpanel│                                     │
│  │    v2        │                                      │
│  └──────────────┘                                      │
│                                                        │
└─────────────────────────────────────────────────────────┘
```

---

## 环境要求

### 硬件要求

- **Muse Pi Pro 开发板** (RISC-V)
  - CPU: 8 核 
  - NPU: SpaceMIT K1, 4 TOPS
  - 存储: 64GB eMMC
  - 操作系统: Bianbu (基于 Linux)

- **外设**
  - USB 摄像头 (设备索引: /dev/video20)
  - Quectel EC800M 4G 模块 (可选)
  - GPIO 驱动板(要选，不然gpio驱动不了)

### 软件要求

- **硬件端**(必须)
  - Python 3.8+
  - SpaceMIT NPU 驱动
  - lgpio、libgpiod 系统库

- **PLC 控制系统**(必须)
  - C++17 编译器
  - CMake 3.10+
  - libgpiod-dev、libmodbus-dev

- **后端服务**(可选，不影响硬件运行)
  - Java 17+
  - Maven 3.6+
  - MySQL 8.0+

- **数据库**(可选，不影响硬件运行)
  - MySQL 8.0+
  - 字符集: utf8mb4

---

## 部署步骤
---

### 1. PLC 控制系统部署（必须，否则无法看到gpio输出）
进入项目目录 plc_cpp

#### 1.1 安装依赖

```bash
sudo apt-get update
sudo apt-get install -y build-essential cmake libgpiod-dev libmodbus-dev pkg-config
```

#### 1.2 编译 PLC 系统

```bash
mkdir -p build
cd build
cmake ..
make
```

#### 1.3 配置 PLC

编辑配置文件（按优先级）：
1. `/home/hyit/plc/plc_config.json` 
2. `config/plc_config.json` 

配置文件示例：

```json
{
  "ladder_diagrams": [
    {
      "name": "YOLO Level 1",
      "conditions": [{"type": "coil", "address": 40}],
      "outputs": [{"type": "output", "address": 0}]
    }
  ]
}
```
若编写困难，项目目录下配套有 plc配置文件生成器.html  可以进行可视化编写。


#### 1.4 运行 PLC 系统

```bash
# 需要 root 权限（GPIO 访问）
cd build
sudo ./plc_core

# 或指定配置文件
sudo ./plc_core /home/hyit/plc/plc_config.json
```
若端口 502 无法绑定，可运行：
```bash
sudo setcap 'cap_net_bind_service=+ep' ./build/plc_core
```

### 1.5 GPIO 连接对照表

| GPIOX | 功能 |
|------|----------------|
| GPIO35 | Q0（调试用呼吸灯） |
| GPIO46 | Q1 |
| GPIO37 | Q2 |
| GPIO71 | Q3（震动马达） |
| GPIO72 | Q4（LED） |
| GPIO73 | Q5（蜂鸣器） |
| GPIO74 | IN1（可选接光电传感器，有人时候启动） |
| GPIO91 | IN2 |
| GPIO92 | IN3 |
| GPIO33 | 总继电器使能 |
| GPIO51 | 指示灯 |
| UART0_TXD | 有线串口调试 |
| UART0_RXD | 有线串口调试 |



#### 1.6 配置开机自启

```bash
sudo nano /etc/systemd/system/plc-core.service
```

服务配置：

```ini
[Unit]
Description=PLC Core Application
After=network.target
Wants=network.target

[Service]
Type=simple
User=YOUR_USER
WorkingDirectory=/path/to/plc_cpp/build
ExecStart=/usr/bin/sudo /path/to/plc_cpp/build/plc_core
Restart=on-failure
RestartSec=5
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

启动服务：

```bash
sudo systemctl daemon-reload
sudo systemctl enable plc-core.service
sudo systemctl start plc-core.service
```

#### 1.7 验证 PLC 系统

```bash
# 检查进程
ps aux | grep plc_core

# 检查 Modbus 端口
sudo netstat -tlnp | grep 502

# 查看日志
sudo journalctl -u plc-core.service -f
```

---

### 2. 硬件端部署（核心部分，包含图像采集，plc通信，数据上报和存储）

#### 2.1 安装系统依赖

```bash
sudo apt-get update
sudo apt-get install -y python3-pip python3-dev libgpiod-dev
```

#### 2.2 安装 Python 依赖（可能比较多）

```bash
cd muse-hardware
pip3 install -r requirements.txt
```

**注意**：如果使用虚拟环境：

```bash
python3 -m venv yolo_env
source yolo_env/bin/activate
pip install -r requirements.txt
```

#### 2.3 配置硬件端

编辑 `config.py`:

```python
# 摄像头配置
CAMERA_CONFIG = {
    "device_index": 20  # 根据实际设备调整
}

# 网络模块配置（如果没有 EC800M，可以禁用）
NETWORK_MODULE_CONFIG = {
    "enabled": True,
    "skip_gnss": False,
    "skip_ntp": False,
    "skip_login": False
}
```

编辑 `network_config.json`:

```json
{
  "device_id": "MUSE_PI_PRO_001",
  "backend_url": "http://YOUR_BACKEND_IP:8080",
  "serial_port": "/dev/ttyUSB2",
  "baud_rate": 115200
}
```

#### 2.4 运行硬件端

```bash
# 普通模式
python3 start.py

# 调试模式
python3 start.py --debug
```

#### 2.5 配置开机自启

```bash
sudo nano /etc/systemd/system/musepiproplus.service
```

服务配置：

```ini
[Unit]
Description=Muse Pi Pro Plus YOLO Service
After=network-online.target
Wants=network-online.target

[Service]
User=YOUR_USER
WorkingDirectory=/path/to/muse-hardware
Environment="PYTHONUNBUFFERED=1"
ExecStart=/bin/bash -lc 'source /path/to/muse-hardware/yolo_env/bin/activate && python start.py'
Restart=on-failure
RestartSec=5
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

启动服务：

```bash
sudo systemctl daemon-reload
sudo systemctl enable musepiproplus.service
sudo systemctl start musepiproplus.service
```

#### 2.6 验证硬件端

```bash
# 检查服务状态
sudo systemctl status musepiproplus.service

# 访问 Web 界面
# 浏览器打开: http://YOUR_DEVICE_IP:5200

# 查看日志
sudo journalctl -u musepiproplus.service -f
```

---







### 3. 数据库部署（可选，不影响硬件运行，如果需要后端接收数据则需要）

#### 3.1 安装 MySQL

```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install mysql-server

# 启动 MySQL
sudo systemctl start mysql
sudo systemctl enable mysql
```

#### 3.2 创建数据库和用户

```bash
# 登录 MySQL
sudo mysql -u root -p

# 创建数据库
CREATE DATABASE muse_v2 CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 创建用户（替换密码）
CREATE USER 'muse_v2'@'%' IDENTIFIED BY 'YOUR_PASSWORD';
GRANT ALL PRIVILEGES ON muse_v2.* TO 'muse_v2'@'%';
FLUSH PRIVILEGES;
EXIT;
```

#### 3.3 导入数据库结构

```bash
# SQL 初始化脚本 位于muse-adminpanelv2
mysql -u muse_v2 -p muse_v2 < init.sql


```

#### 3.4 验证数据库

```bash
mysql -u muse_v2 -p muse_v2 -e "SHOW TABLES;"
```

---

### 4. 后端服务部署（可选，不影响硬件运行，如果需要后端接收数据则需要）

#### 4.1 安装 Java 和 Maven

```bash
# 安装 Java 17
sudo apt-get install openjdk-17-jdk

# 验证 Java 版本
java -version

# 安装 Maven
sudo apt-get install maven

# 验证 Maven 版本
mvn -version
```

#### 4.2 配置数据库连接

编辑 `muse-backendv2/src/main/resources/application.properties`:

```properties
# 数据库配置
spring.datasource.url=jdbc:mysql://YOUR_DB_HOST:3306/muse_v2?useSSL=false&serverTimezone=UTC&characterEncoding=utf8&allowPublicKeyRetrieval=true
spring.datasource.username=muse_v2
spring.datasource.password=YOUR_PASSWORD

# JWT 配置（生产环境请修改密钥）
jwt.secret=YOUR_SECRET_KEY
jwt.expiration=86400000

# 高德地图 API 配置（可选）
amap.api.key=YOUR_AMAP_KEY
amap.api.secret=YOUR_AMAP_SECRET
```

#### 4.3 编译项目

```bash
cd muse-backendv2
mvn clean package -DskipTests
```

#### 4.4 运行服务

```bash
# 方式一：直接运行 JAR
java -jar target/muse-backendv2-0.0.1-SNAPSHOT.jar

# 方式二：使用 systemd 服务
sudo nano /etc/systemd/system/muse-backendv2.service
```

systemd 服务配置：

```ini
[Unit]
Description=Muse Backend V2 Service
After=network.target mysql.service
Wants=network.target

[Service]
Type=simple
User=YOUR_USER
WorkingDirectory=/path/to/muse-backendv2
ExecStart=/usr/bin/java -jar /path/to/muse-backendv2/target/muse-backendv2-0.0.1-SNAPSHOT.jar
Restart=on-failure
RestartSec=5
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

启动服务：

```bash
sudo systemctl daemon-reload
sudo systemctl enable muse-backendv2.service
sudo systemctl start muse-backendv2.service
sudo systemctl status muse-backendv2.service
```

#### 4.5 验证后端服务

```bash
# 检查服务状态
curl http://localhost:8080/api/v2/auth/token?deviceId=TEST_DEVICE

# 查看日志
sudo journalctl -u muse-backendv2.service -f
```



## 系统启动顺序

若您需要体验完整的系统运行，为确保系统正常运行，建议按以下顺序启动：

1. **数据库服务**
   ```bash
   sudo systemctl start mysql
   ```

2. **后端服务**
   ```bash
   sudo systemctl start muse-backendv2.service
   ```

3. **PLC 控制系统**
   ```bash
   sudo systemctl start plc-core.service
   ```
   **等待约 0 分钟**，直到 PLC 就绪（指示灯快闪）

4. **硬件端**
   ```bash
   sudo systemctl start musepiproplus.service
   ```
   **等待约 1 分钟**，直到 YOLO 就绪（指示灯慢闪）

### 启动状态指示

- **系统上电开机**：指示灯常亮
- **PLC 就绪（约 2 分钟）**：指示灯快闪
- **YOLO 就绪（再约 1 分钟）**：指示灯慢闪，系统正常工作

---

## 验证与测试

### 1. 后端服务测试

```bash
# 测试 Token 获取接口
curl -X POST "http://localhost:8080/api/v2/auth/token?deviceId=TEST_DEVICE"


### 2. PLC 系统测试

```bash
# 检查 Modbus 连接
sudo netstat -tlnp | grep 502

# 使用 modbus 客户端测试（需要安装）
modbus read 127.0.0.1 502 0 1
```

### 3. 硬件端测试

```bash
# 访问 Web 界面
# http://YOUR_DEVICE_IP:5200

# 检查视频流
curl http://YOUR_DEVICE_IP:5200/feed/webcam/

# 检查系统状态
curl http://YOUR_DEVICE_IP:5200/status
```

### 4. 端到端测试

1. **硬件端检测到疲劳行为**
   - 观察 Web 界面显示检测结果
   - 检查疲劳等级是否正确

2. **PLC 联动测试**
   - 当疲劳等级达到 Level 1/2/3 时
   - 检查 GPIO 输出是否正确（LED/振动/蜂鸣器）

3. **数据上报测试**
   - 检查后端服务是否收到数据
   - 查看数据库是否写入数据

---

## 故障排除

### 1. 数据库连接失败

**问题**：后端服务无法连接数据库

**解决方案**：
- 检查 MySQL 服务是否运行：`sudo systemctl status mysql`
- 检查数据库用户权限
- 检查防火墙设置
- 查看后端服务日志：`sudo journalctl -u muse-backendv2.service -f`

### 2. PLC Modbus 连接失败

**问题**：硬件端无法连接 PLC

**解决方案**：
- 检查 PLC 服务是否运行：`sudo systemctl status plc-core.service`
- 检查端口 502 是否被占用：`sudo netstat -tlnp | grep 502`
- 检查防火墙设置
- 查看 PLC 日志：`sudo journalctl -u plc-core.service -f`

### 3. 硬件端摄像头无法打开

**问题**：摄像头初始化失败

**解决方案**：
- 检查摄像头设备索引：`v4l2-ctl --list-devices`
- 检查设备权限：`ls -l /dev/video20`
- 修改 `config.py` 中的 `device_index`

### 4. 数据上报失败

**问题**：硬件端无法上报数据到后端

**解决方案**：
- 检查网络连接
- 检查后端服务地址和端口
- 检查设备 ID 配置
- 使用测试模式：`?device_id=YOUR_DEVICE_ID`
- 查看网络管理器日志

### 5. GPIO 控制失败

**问题**：PLC 无法控制 GPIO

**解决方案**：
- 检查 GPIO 权限：`ls -l /dev/gpiochip*`
- 检查用户是否在 gpio 组中
- 检查 GPIO 连接是否正确
- 查看 PLC 日志

---

## 维护与监控

### 1. 日志管理

**后端服务日志**：
```bash
sudo journalctl -u muse-backendv2.service -f
```

**PLC 系统日志**：
```bash
sudo journalctl -u plc-core.service -f
```

**硬件端日志**：
```bash
# 应用日志
tail -f muse-hardware/app_log.txt

# 性能监控日志
tail -f muse-hardware/performance_logs/performance_*.log

# systemd 日志
sudo journalctl -u musepiproplus.service -f
```

### 2. 性能监控

**硬件端性能监控**：
- 启用性能监控：编辑 `config.py`，设置 `PERFORMANCE_MONITOR_CONFIG["enabled"] = True`
- 查看性能日志：`tail -f performance_logs/performance_*.log`

**系统资源监控**：
```bash
# CPU 和内存
top

# 磁盘使用
df -h

# 网络连接
netstat -an | grep ESTABLISHED
```

### 3. 数据库维护

**定期备份**：
```bash
# 备份数据库
mysqldump -u muse_v2 -p muse_v2 > backup_$(date +%Y%m%d).sql

# 恢复数据库
mysql -u muse_v2 -p muse_v2 < backup_20250115.sql
```

**清理旧数据**（可选）：
```sql
-- 清理 30 天前的状态数据
DELETE FROM status_data WHERE timestamp < UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 30 DAY)) * 1000;

-- 清理 90 天前的事件数据
DELETE FROM event_data WHERE timestamp < UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 90 DAY)) * 1000;
```

### 4. 服务管理

**查看所有服务状态**：
```bash
sudo systemctl status muse-backendv2.service
sudo systemctl status plc-core.service
sudo systemctl status musepiproplus.service
```

**重启服务**：
```bash
sudo systemctl restart muse-backendv2.service
sudo systemctl restart plc-core.service
sudo systemctl restart musepiproplus.service
```

**停止服务**：
```bash
sudo systemctl stop muse-backendv2.service
sudo systemctl stop plc-core.service
sudo systemctl stop musepiproplus.service
```

---

## 相关文档（若对某个方面有疑问，优先参考对应的文档）

- **硬件端文档**：`muse-hardware/README.md`
- **PLC 系统文档**：`plc_cpp/README.md`
- **后端服务文档**：`muse-backendv2/README.md`
- **API 接口规范**：`muse-hardware/HARDWARE_DATA_API_SPECIFICATION-确定稿.md`
- **数据库设计**：`muse-backendv2/V2_DATABASE_DESIGN.md`

---

## 版本信息

- **文档版本**：v1.0
- **最后更新**：2025-12-06
- **适用系统版本**：
  - 硬件端：v2.0
  - PLC 系统：v1.0
  - 后端服务：v2.0

---

## 联系方式

如有问题或建议，请联系：
- **项目地址**：https://gitee.com/achenjiayi/MusePiPro_Driving_Detecte
- **Issues**：https://gitee.com/achenjiayi/MusePiPro_Driving_Detecte/issues
- **邮箱**： zhangyile577@qq.com 

---

**注意**：本文档会持续更新，请定期查看最新版本。






