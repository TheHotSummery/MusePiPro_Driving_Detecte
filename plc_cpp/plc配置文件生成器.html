<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLCé…ç½®ç³»ç»Ÿ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #edf0fd 0%, #f5effa 100%); /* æµ…ç°æ¸å˜èƒŒæ™¯ï¼Œæ›¿æ¢è“ç´«è‰² */
            min-height: 100vh; 
        }
        #app { padding: 20px; max-width: 1400px; margin: 0 auto; }
        .header {
			background: white;
			border-radius: 12px;
			padding: 24px;
			margin-bottom: 20px;
			box-shadow: 0 4px 6px rgba(0,0,0,0.1);
			/* --- æ–°å¢ --- */
			position: sticky;
			top: 0;
			z-index: 10;
		}.header h1 { color: #2d3748; font-size: 28px; margin-bottom: 16px; }
        .toolbar { display: flex; gap: 12px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 6px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn-primary { background: #4299e1; color: white; }
        .btn-success { background: #48bb78; color: white; }
        .btn-warning { background: #ed8936; color: white; }
        .btn-danger { background: #f56565; color: white; }
        .btn-secondary { background: #718096; color: white; }
        .main-content { display: grid; grid-template-columns: 300px 1fr; gap: 20px; }
        .sidebar { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); height: fit-content; position: sticky; top: 20px; }
        .sidebar-section { margin-bottom: 24px; }
        .sidebar-section h3 { color: #2d3748; font-size: 16px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0; }
        .resource-item { background: #f7fafc; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #4299e1; }
        .resource-item input { width: 100%; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; margin-top: 6px; font-size: 13px; }
        .resource-label { display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: #2d3748; margin-bottom: 4px; }
        .resource-alias { font-size: 12px; color: #718096; font-weight: normal; }
        .editor-area { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .rung-card { background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 12px 20px; margin-bottom: 10px; transition: all 0.3s; }
        .rung-card:hover { border-color: #4299e1; box-shadow: 0 4px 12px rgba(66, 153, 225, 0.15); }
        .rung-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 18px; border-bottom: 2px solid #e2e8f0; }
        .rung-title { font-size: 18px; font-weight: 700; color: #2d3748; }
        .rung-actions { display: flex; gap: 8px; }
        .icon-btn { width: 32px; height: 32px; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-size: 16px; }
        .icon-btn:hover { transform: scale(1.1); }
        .section-title { font-size: 14px; font-weight: 600; color: #4a5568; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .section-title::before { content: ''; width: 4px; height: 16px; background: #4299e1; border-radius: 2px; }
        .conditions-area { background: white; padding: 16px; border-radius: 8px; margin-bottom: 16px; border: 2px dashed #cbd5e0; }
        .condition-row { display: grid; grid-template-columns: 140px 1fr 120px 40px; gap: 12px; align-items: center; margin-bottom: 8px; padding:8px 12px; background: #f7fafc; border-radius: 8px; border-left: 3px solid #48bb78; }
        .action-row { display: grid; grid-template-columns: 180px 1fr; gap: 12px; align-items: center; padding: 12px; background: #fff5f5; border-radius: 8px; border-left: 4px solid #f56565; }
        select, input[type="number"], input[type="text"] { padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px; transition: border-color 0.2s; }
        select:focus, input:focus { outline: none; border-color: #4299e1; }
        .checkbox-label {
			display: flex;
			align-items: center;
			gap: 8px; /* å¢å¤§é—´è· */
			font-size: 13px;
			color: #4a5568;
			cursor: pointer; /* è®©æ•´ä¸ªæ ‡ç­¾éƒ½å¯ç‚¹å‡» */
		}
		.checkbox-label input[type="checkbox"] {
			transform: scale(1.5); /* æ”¾å¤§åˆ°1.5å€ */
			margin: 0 4px; /* è°ƒæ•´è¾¹è·ä»¥é€‚åº”æ”¾å¤§ */
		}
        .empty-state { text-align: center; padding: 60px 20px; color: #718096; }
        .empty-state-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.3; }
        .add-condition-btn { width: 100%; padding: 10px; background: #edf2f7; border: 2px dashed #cbd5e0; border-radius: 8px; color: #4a5568; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .add-condition-btn:hover { background: #e2e8f0; border-color: #4299e1; color: #2d3748; }
        .help-text { font-size: 12px; color: #718096; margin-top: 4px; font-style: italic; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .status-ok { background: #c6f6d5; color: #22543d; }
        .status-error { background: #fed7d7; color: #742a2a; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; border-radius: 12px; padding: 24px; max-width: 600px; max-height: 80vh; overflow-y: auto; }
        .resource-input-group { margin-bottom: 16px; }
        .resource-input-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #2d3748; }
    </style>
</head>
<body>
    <div id="app">
        <!-- å¤´éƒ¨å·¥å…·æ ï¼šä¿ç•™é¢„è§ˆæ¢¯å½¢å›¾æŒ‰é’® -->
        <div class="header">
            
            <div class="toolbar"><h2>PLCé…ç½®ç³»ç»Ÿ</h1>
                <button class="btn btn-danger" @click="showPreviewModal = true">ğŸ“Š é¢„è§ˆæ¢¯å½¢å›¾</button>
                <button class="btn btn-primary" @click="addRung">â• æ·»åŠ æ¢¯çº§</button>
                <button class="btn btn-success" @click="showAddTimer = true">â±ï¸ æ·»åŠ å®šæ—¶å™¨</button>
                <button class="btn btn-success" @click="showAddCounter = true">ğŸ”¢ æ·»åŠ è®¡æ•°å™¨</button>
                <button class="btn btn-warning" @click="saveConfig">ğŸ’¾ ä¿å­˜é…ç½®</button>
                <button class="btn btn-secondary" @click="downloadConfig">â¬‡ï¸ ä¸‹è½½</button>
                <label class="btn btn-secondary" style="margin: 0;">
                    â¬†ï¸ ä¸Šä¼ 
                    <input type="file" @change="loadConfig" accept=".json" style="display:none">
                </label>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <!-- å·¦ä¾§èµ„æºé¢æ¿ï¼šæ•´åˆI/Oè¯´æ˜ä¸å¸®åŠ©è¯´æ˜ -->
            <div class="sidebar">
                <!-- å®šæ—¶å™¨èµ„æº -->
                <div class="sidebar-section">
                    <h3> å®šæ—¶å™¨ ({{ config.timers.length }})</h3>
                    <div v-for="(timer, idx) in config.timers" :key="'t'+idx" class="resource-item">
                        <div class="resource-label">
                            <span>{{ timer.name }}</span>
                            <button class="icon-btn" style="background:#f56565;color:white" @click="removeResource('timers', idx)">ğŸ—‘ï¸</button>
                        </div>
                        <input v-model="timer.alias" placeholder="åˆ«åï¼ˆå¦‚ï¼šåŠ çƒ­å»¶æ—¶ï¼‰" />
                        <input type="number" v-model.number="timer.preset" step="0.1" min="0.2" placeholder="é¢„è®¾æ—¶é—´ï¼ˆç§’ï¼‰" @change="validateTimerPreset(idx)" />
                        <div class="help-text">{{ timer.preset }}ç§’åå®Œæˆä½ON</div>
                    </div>
                </div>

                <!-- è®¡æ•°å™¨èµ„æº -->
                <div class="sidebar-section">
                    <h3>è®¡æ•°å™¨ ({{ config.counters.length }})</h3>
                    <div v-for="(counter, idx) in config.counters" :key="'c'+idx" class="resource-item">
                        <div class="resource-label">
                            <span>{{ counter.name }}</span>
                            <button class="icon-btn" style="background:#f56565;color:white" @click="removeResource('counters', idx)">ğŸ—‘ï¸</button>
                        </div>
                        <input v-model="counter.alias" placeholder="åˆ«åï¼ˆå¦‚ï¼šäº§å“è®¡æ•°ï¼‰" />
                        <input type="number" v-model.number="counter.preset" placeholder="é¢„è®¾è®¡æ•°" @change="validateCounterPreset(idx)" />
                        <div class="help-text">è®¡æ•°{{ counter.preset }}æ¬¡åå®Œæˆä½ON</div>
                    </div>
                </div>

            <!-- [ä¿®æ”¹] I/O & Mä½ è¯´æ˜ -->
            <div class="sidebar-section">
                <h3>I/O & Mä½è¯´æ˜</h3>
                <div style="font-size:13px;color:#4a5568;line-height:1.6">
                    <p><strong>è¾“å…¥ (I)</strong>: I0, I1, I2</p>
                    <p style="line-height:1.2; font-size:12px; color:#718096;">ç‰©ç†è¾“å…¥ä¿¡å·</p>
                    <hr style="margin: 8px 0;">

                    <p><strong>ç”¨æˆ·è¾“å‡º (Q)</strong>: Q0, Q1, Q2, Q3, Q4, Q5</p>
                    <p style="line-height:1.2; font-size:12px; color:#718096;">ç”¨æˆ·å¯è‡ªç”±æ§åˆ¶çš„ç‰©ç†è¾“å‡ºï¼ˆå…±6è·¯ï¼‰</p>
                    <hr style="margin: 8px 0;">

                    <p><strong>ä¸­é—´ç»§ç”µå™¨ (M)</strong></p>
                    <p><strong>M0-M39</strong>: <strong style="color: #2b6cb0;">ç”¨æˆ·åŒº (å¯è¯»å†™)</strong></p>
                    <p style="line-height:1.2; font-size:12px; color:#718096;">ç”¨äºå­˜å‚¨ç”¨æˆ·ç¨‹åºçš„ä¸­é—´é€»è¾‘çŠ¶æ€ã€‚</p>
                    
                    <p style="margin-top:8px"><strong>M40-M45</strong>: <strong style="color: #c53030;">ç³»ç»ŸåŒº (YOLO, åªè¯»)</strong></p>
                    <p style="line-height:1.2; font-size:12px; color:#718096;">ç”±AIç³»ç»Ÿå†™å…¥ï¼Œåæ˜ æ£€æµ‹ç»“æœï¼Œç”¨æˆ·åªèƒ½è¯»å–ã€‚</p>
                    
                    <p style="margin-top:8px"><strong>M46</strong>: <strong style="color: #c53030;">é¢„ç•™</strong></p>
                    <p style="line-height:1.2;font-size:12px;color:#718096">ç³»ç»Ÿé¢„ç•™ä½ã€‚</p>
                </div>
            </div>

                <!-- å¸®åŠ©ä¸æŠ€æœ¯è¯´æ˜ï¼šä¿ç•™æ—§ä»£ç çš„æŠ˜å åŠŸèƒ½ -->
                <div class="sidebar-section">
                    <h3 @click="isHelpVisible = !isHelpVisible" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                        <span>å¸®åŠ©ä¸æŠ€æœ¯è¯´æ˜</span>
                        <span style="font-size: 18px; transition: transform 0.3s;" :style="{ transform: isHelpVisible ? 'rotate(180deg)' : 'rotate(0deg)' }">â–¼</span>
                    </h3>
                    <div v-if="isHelpVisible" style="font-size: 13px; color: #4a5568; line-height: 1.7; padding-top: 12px;">
                        <!-- å¸¸å¼€/å¸¸é—­è¯´æ˜ -->
                        <p style="margin-bottom: 12px;">
                            <strong>å¸¸å¼€/å¸¸é—­è§¦ç‚¹ (NO/NC):</strong>
                            <ul style="list-style-position: inside; padding-left: 8px;">
                                <li><strong>å¸¸å¼€ (Normally Open):</strong> å½“ç‰©ç†ä¿¡å·ä¸º"ON"(é«˜ç”µå¹³)æ—¶ï¼Œæ¡ä»¶ä¸º<strong style="color: #22543d;">çœŸ</strong>ã€‚ä¾‹å¦‚ï¼šIF (è¾“å…¥I0ä¸ºON) THEN...</li>
                                <li><strong>å¸¸é—­ (Normally Closed):</strong> å½“ç‰©ç†ä¿¡å·ä¸º"OFF"(ä½ç”µå¹³)æ—¶ï¼Œæ¡ä»¶ä¸º<strong style="color: #22543d;">çœŸ</strong>ã€‚å®ƒæ˜¯å¯¹ç‰©ç†ä¿¡å·çš„"å–å"ã€‚ä¾‹å¦‚ï¼šIF (è¾“å…¥I0ä¸ºOFF) THEN...</li>
                            </ul>
                        </p>
                        <!-- å®šæ—¶å™¨è¯´æ˜ -->
						<!-- å®šæ—¶å™¨è¯´æ˜ (ä¿®æ­£ç‰ˆ) -->
						<p style="margin-bottom: 12px;">
							<strong>å®šæ—¶å™¨ (Timer):</strong>
							<ul style="list-style-position: inside; padding-left: 8px;">
								<li><strong>è§¦å‘æ–¹å¼ (TON):</strong> è¿™æ˜¯ä¸€ä¸ªæ ‡å‡†çš„"é€šç”µå»¶æ—¶å®šæ—¶å™¨"ã€‚å½“"å¯åŠ¨å®šæ—¶å™¨"åŠ¨ä½œçš„æ¡ä»¶ä¸º<strong style="color: #22543d;">çœŸ</strong>æ—¶ï¼Œå®šæ—¶å™¨å¼€å§‹è®¡æ—¶ã€‚åªè¦æ¡ä»¶ä¿æŒä¸º"çœŸ"ï¼Œè®¡æ—¶å°±ä¼šç»§ç»­ã€‚</li>
								<li><strong>å®ŒæˆçŠ¶æ€ (DN):</strong> å½“ç´¯è®¡æ—¶é—´è¾¾åˆ°é¢„è®¾å€¼ï¼Œå®šæ—¶å™¨çš„"å®Œæˆä½(DN)"å°†å˜ä¸º"ON"ï¼Œå¹¶**ä¿æŒONçŠ¶æ€**ï¼Œç›´åˆ°å®šæ—¶å™¨è¢«å¤ä½ã€‚</li>
								<li><strong>å¤ä½æœºåˆ¶ (Reset):</strong> å®šæ—¶å™¨**ä¸ä¼šè‡ªåŠ¨å¤ä½**å…¶"å®Œæˆä½(DN)"ï¼Œå®ƒé€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼å¤ä½ï¼š
									<ol style="list-style-type: decimal; padding-left: 20px; margin-top: 4px;">
										<li><strong>éšå¼å¤ä½:</strong> å½“"å¯åŠ¨å®šæ—¶å™¨"çš„æ¡ä»¶ä»"çœŸ"å˜ä¸º"å‡"æ—¶ï¼Œå®šæ—¶å™¨å°†**è‡ªåŠ¨åœæ­¢è®¡æ—¶å¹¶æ¸…é›¶ç´¯è®¡æ—¶é—´**ï¼Œå…¶"å®Œæˆä½(DN)"ä¹Ÿéšä¹‹å˜ä¸º"OFF"ã€‚</li>
										<li><strong>æ˜¾å¼å¤ä½:</strong> å½“"å¤ä½å®šæ—¶å™¨"åŠ¨ä½œçš„æ¡ä»¶ä¸º"çœŸ"æ—¶ï¼Œå®šæ—¶å™¨å°†è¢«**å¼ºåˆ¶æ¸…é›¶**ï¼Œæ— è®ºå…¶å¯åŠ¨æ¡ä»¶æ˜¯å¦ä¸ºçœŸã€‚</li>
									</ol>
								</li>
							</ul>
						</p>
                        <!-- è®¡æ•°å™¨è¯´æ˜ -->
                        <p style="margin-bottom: 12px;">
                            <strong>è®¡æ•°å™¨ (Counter):</strong>
                            <ul style="list-style-position: inside; padding-left: 8px;">
                                <li><strong>è§¦å‘æ–¹å¼:</strong> é‡‡ç”¨**ä¸Šå‡æ²¿è§¦å‘**ï¼Œä»…åœ¨æ¡ä»¶ä»"å‡"å˜"çœŸ"æ—¶è®¡æ•°+1ï¼Œæ¡ä»¶æŒç»­ä¸º"çœŸ"ä¸é‡å¤è®¡æ•°ã€‚</li>
                                <li><strong>å®ŒæˆçŠ¶æ€ (DN):</strong> è®¡æ•°å€¼è¾¾åˆ°é¢„è®¾å€¼æ—¶ï¼Œ"å®Œæˆä½(DN)"å˜"ON"å¹¶ä¿æŒï¼Œç›´åˆ°å¤ä½ã€‚</li>
                                <li><strong>å¤ä½æœºåˆ¶:</strong> è®¡æ•°å™¨**ä¸ä¼šè‡ªåŠ¨å¤ä½**ï¼Œå¿…é¡»é€šè¿‡"å¤ä½è®¡æ•°å™¨"åŠ¨ä½œæ¸…é›¶ã€‚</li>
                            </ul>
                        </p>
                        <!-- æ‰§è¡Œé€»è¾‘è¯´æ˜ -->
                        <p>
                            <strong>ç¨‹åºæ‰§è¡Œé€»è¾‘:</strong>
                            <ul style="list-style-position: inside; padding-left: 8px;">
                                <li>ç¨‹åºä»**æ¢¯çº§1**å¼€å§‹ï¼ŒæŒ‰é¡ºåº**ä»ä¸Šåˆ°ä¸‹**æ‰«ææ‰§è¡Œï¼Œæ¢¯çº§é¡ºåºå½±å“è¾“å‡ºç»“æœï¼Œéœ€åˆç†æ’åºã€‚</li>
                            </ul>
                        </p>
                        <p>
                            <strong>å¤šè¾“å‡ºè¯´æ˜:</strong>
                            <ul style="list-style-position: inside; padding-left: 8px;">
                                <li>åŒä¸€ç»„æ¡ä»¶æ§åˆ¶å¤šä¸ªè¾“å‡ºæ—¶ï¼Œéœ€ä¸ºæ¯ä¸ªè¾“å‡ºåˆ›å»ºç‹¬ç«‹æ¢¯çº§å¹¶å¤åˆ¶æ¡ä»¶ã€‚</li>
                            </ul>
                        </p>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§æ¢¯çº§ç¼–è¾‘å™¨ï¼šæ•´åˆæ–°æ—§ä»£ç é€»è¾‘ä¼˜åŒ– -->
            <div class="editor-area">
                <div v-if="config.rungs.length === 0" class="empty-state">
                    <div class="empty-state-icon">ğŸ“</div>
                    <h3>è¿˜æ²¡æœ‰æ¢¯çº§ç¨‹åº</h3>
                    <p>ç‚¹å‡»"æ·»åŠ æ¢¯çº§"å¼€å§‹åˆ›å»ºæ‚¨çš„PLCç¨‹åº</p>
                </div>

                <div v-for="(rung, rungIdx) in config.rungs" :key="rung.id" class="rung-card">
                    <!-- æ¢¯çº§å¤´éƒ¨ -->
                    <div class="rung-header">
                        <div class="rung-title">æ¢¯çº§ {{ rungIdx + 1 }}</div>
                        <div class="rung-actions">
                            <button class="icon-btn" style="background:#4299e1;color:white" @click="moveRungUp(rungIdx)" :disabled="rungIdx === 0">â¬†ï¸</button>
                            <button class="icon-btn" style="background:#4299e1;color:white" @click="moveRungDown(rungIdx)" :disabled="rungIdx === config.rungs.length - 1">â¬‡ï¸</button>
                            <button class="icon-btn" style="background:#f56565;color:white" @click="deleteRung(rungIdx)">ğŸ—‘ï¸</button>
                        </div>
                    </div>

                    <!-- æ¡ä»¶åŒºåŸŸï¼šä¿ç•™ä¸­é—´ç»§ç”µå™¨ç±»å‹ï¼Œä¿®å¤æ˜¾ç¤ºé€»è¾‘ -->
                    <div>
                        <div class="section-title">ğŸ” è§¦å‘æ¡ä»¶ï¼ˆæ‰€æœ‰æ¡ä»¶å¿…é¡»åŒæ—¶æ»¡è¶³ï¼‰</div>
                        <div class="conditions-area">
                            <div v-if="rung.conditions.length === 0" style="text-align:center;color:#718096;padding:20px">
                                <p>æš‚æ— æ¡ä»¶ï¼ˆé»˜è®¤ä¸ºçœŸï¼‰</p>
                                <p style="font-size:12px;margin-top:8px">æ·»åŠ æ¡ä»¶æ¥æ§åˆ¶æ­¤æ¢¯çº§çš„æ‰§è¡Œ</p>
                            </div>

                            <div v-for="(cond, condIdx) in rung.conditions" :key="'cond'+condIdx" class="condition-row">
                                <!-- æ¡ä»¶ç±»å‹ï¼šå¢åŠ ä¸­é—´ç»§ç”µå™¨é€‰é¡¹ -->
                                <select v-model="cond.type" @change="onConditionTypeChange(rung, cond)">
                                    <option value="input">ğŸ“¥ è¾“å…¥</option>
                                    <option value="output">ğŸ“¤ è¾“å‡º</option>
                                    <option value="memory">ğŸ’¾ ä¸­é—´ç»§ç”µå™¨ (M)</option>
                                    <option value="timer">â±ï¸ å®šæ—¶å™¨</option>
                                    <option value="counter">ğŸ”¢ è®¡æ•°å™¨</option>
                                </select>

                                <!-- æ ¹æ®ç±»å‹æ˜¾ç¤ºä¸åŒé€‰é¡¹ -->
                                <div style="display:flex;gap:8px;align-items:center; flex:1">
                                    <select v-if="cond.type === 'input'" v-model="cond.input"><option>I0</option><option>I1</option><option>I2</option></select>
                                    <select v-if="cond.type === 'output'" v-model="cond.output"><option>Q0</option><option>Q1</option><option>Q2</option><option>Q3</option><option>Q4</option><option>Q5</option></select>
                                    <select v-if="cond.type === 'memory'" v-model="cond.memory" style="width:100%">
                                        <optgroup label="ç”¨æˆ·åŒº (å¯è¯»å†™)">
                                            <option v-for="m in userMemoryBits" :key="m" :value="m">{{ m }}</option>
                                        </optgroup>
                                        <optgroup label="ç³»ç»ŸåŒº (YOLO, åªè¯»)">
                                            <option v-for="m in yoloMemoryBits" :key="m" :value="m">{{ m }}</option>
                                        </optgroup>
                                    </select>
                                    <select v-if="cond.type === 'timer'" v-model="cond.timer">
                                        <option v-for="t in config.timers" :value="t.name">{{ t.name }}{{ t.alias ? ` (${t.alias})` : '' }}</option>
                                    </select>
                                    <select v-if="cond.type === 'counter'" v-model="cond.counter">
                                        <option v-for="c in config.counters" :value="c.name">{{ c.name }}{{ c.alias ? ` (${c.alias})` : '' }}</option>
                                    </select>
                                </div>

                                <!-- å¸¸å¼€/å¸¸é—­ï¼šä¿®å¤æ˜¾ç¤ºé€»è¾‘ -->
                                <div v-if="['input', 'output', 'memory'].includes(cond.type)">
                                    <label class="checkbox-label">
                                        <input type="checkbox" v-model="cond.normally_open" />
                                        <span>{{ cond.normally_open ? 'å¸¸å¼€è§¦ç‚¹' : 'å¸¸é—­è§¦ç‚¹' }}</span>
                                    </label>
                                </div>
                                <div v-else class="help-text" style="text-align:center">
                                    {{ cond.type === 'timer' ? 'æ—¶é—´åˆ°(DN)' : 'è®¡æ•°æ»¡(DN)' }}
                                </div>

                                <!-- åˆ é™¤æŒ‰é’® -->
                                <button class="icon-btn" style="background:#f56565;color:white" @click="deleteCondition(rung, condIdx)">âŒ</button>
                            </div>

                            <button class="add-condition-btn" @click="addCondition(rung)">â• æ·»åŠ æ¡ä»¶</button>
                        </div>
                    </div>

                    <!-- åŠ¨ä½œåŒºåŸŸï¼šä¿ç•™ä¸­é—´ç»§ç”µå™¨æ§åˆ¶ï¼Œå¢åŠ åŠ¨ä½œè¯´æ˜ -->
                    <div>
                        <div class="section-title">âš¡ æ‰§è¡ŒåŠ¨ä½œï¼ˆæ¡ä»¶æ»¡è¶³æ—¶æ‰§è¡Œï¼‰</div>
                        <div class="action-row">
                            <!-- åŠ¨ä½œç±»å‹ï¼šå¢åŠ ä¸­é—´ç»§ç”µå™¨ç½®ä½/å¤ä½ -->
                            <select v-model="rung.action.type" @change="onActionTypeChange(rung)">
                                <optgroup label="è¾“å‡ºæ§åˆ¶">
                                    <option value="output">ğŸ“¤ è¾“å‡ºï¼ˆè·Ÿéšæ¡ä»¶ï¼‰</option>
                                    <option value="set">ğŸ”’ ç½®ä½è¾“å‡º (SET)</option>
                                    <option value="reset">ğŸ”“ å¤ä½è¾“å‡º (RESET)</option>
                                </optgroup>
                                <optgroup label="ä¸­é—´ç»§ç”µå™¨">
                                    <option value="memory_set">ğŸ’¾ ç½®ä½Mä½ (SET)</option>
                                    <option value="memory_reset">ğŸ”„ å¤ä½Mä½ (RESET)</option>
                                </optgroup>
                                <optgroup label="å®šæ—¶å™¨">
                                    <option value="timer">â±ï¸ å¯åŠ¨å®šæ—¶å™¨ (TON)</option>
                                    <option value="reset_timer">ğŸ”„ å¤ä½å®šæ—¶å™¨ (RESET)</option>
                                </optgroup>
                                <optgroup label="è®¡æ•°å™¨">
                                    <option value="counter">ğŸ”¢ è®¡æ•°å™¨è®¡æ•° (CTU)</option>
                                    <option value="reset_counter">ğŸ”„ å¤ä½è®¡æ•°å™¨ (RESET)</option>
                                </optgroup>
                            </select>

                            <!-- æ ¹æ®åŠ¨ä½œç±»å‹æ˜¾ç¤ºé€‰é¡¹ + åŠ¨ä½œè¯´æ˜ -->
                            <div style="display:flex;gap:12px;align-items:center;flex:1">
                                <select v-if="['output','set','reset'].includes(rung.action.type)" v-model="rung.action.output" style="flex:1">
                                    <option value="Q0">Q0</option>
                                    <option value="Q1">Q1</option>
                                    <option value="Q2">Q2</option>
                                    <option value="Q3">Q3</option>
                                    <option value="Q4">Q4</option>
                                    <option value="Q5">Q5</option>
                                </select>
                                <select v-if="['memory_set','memory_reset'].includes(rung.action.type)" v-model="rung.action.memory" style="flex:1">
                                    <option v-for="m in userMemoryBits" :key="m" :value="m">{{ m }}</option>
                                </select>
                                <select v-if="['timer','reset_timer'].includes(rung.action.type)" v-model="rung.action.timer" style="flex:1">
                                    <option v-for="t in config.timers" :value="t.name">{{ t.name }}{{ t.alias ? ` (${t.alias})` : '' }}</option>
                                </select>
                                <select v-if="['counter','reset_counter'].includes(rung.action.type)" v-model="rung.action.counter" style="flex:1">
                                    <option v-for="c in config.counters" :value="c.name">{{ c.name }}{{ c.alias ? ` (${c.alias})` : '' }}</option>
                                </select>
                                <!-- åŠ¨ä½œè¯´æ˜æ–‡æœ¬ -->
                                <span class="help-text" style="flex:1">
                                    <span v-if="rung.action.type === 'output'">æ¡ä»¶çœŸæ—¶ONï¼Œå‡æ—¶OFF</span>
                                    <span v-if="rung.action.type === 'set'">æ¡ä»¶çœŸæ—¶ç½®ä½ï¼Œéœ€å¤ä½æŒ‡ä»¤æ¸…é™¤</span>
                                    <span v-if="rung.action.type === 'reset'">æ¡ä»¶çœŸæ—¶æ¸…é™¤è¾“å‡º</span>
                                    <span v-if="rung.action.type === 'memory_set'">æ¡ä»¶çœŸæ—¶ç½®ä½Mä½</span>
                                    <span v-if="rung.action.type === 'memory_reset'">æ¡ä»¶çœŸæ—¶å¤ä½Mä½</span>
                                    <span v-if="rung.action.type === 'timer'">æ¡ä»¶çœŸæ—¶å¼€å§‹è®¡æ—¶</span>
                                    <span v-if="rung.action.type === 'reset_timer'">æ¡ä»¶çœŸæ—¶æ¸…é›¶å®šæ—¶å™¨</span>
                                    <span v-if="rung.action.type === 'counter'">æ¡ä»¶ä¸Šå‡æ²¿è®¡æ•°</span>
                                    <span v-if="rung.action.type === 'reset_counter'">æ¡ä»¶çœŸæ—¶æ¸…é›¶è®¡æ•°å™¨</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¨¡æ€æ¡†ï¼šå®Œæ•´ä¿ç•™æ‰€æœ‰åŠŸèƒ½æ¨¡æ€æ¡† -->
        <!-- æ·»åŠ å®šæ—¶å™¨æ¨¡æ€æ¡† -->
        <div v-if="showAddTimer" class="modal" @click.self="showAddTimer = false">
            <div class="modal-content">
                <h2 style="margin-bottom:20px">â±ï¸ æ·»åŠ å®šæ—¶å™¨</h2>
                <div class="resource-input-group">
                    <label>å®šæ—¶å™¨åç§°</label>
                    <input v-model="newTimer.name" placeholder="ä¾‹å¦‚ï¼šT0" />
                </div>
                <div class="resource-input-group">
                    <label>åˆ«åï¼ˆå¯é€‰ï¼‰</label>
                    <input v-model="newTimer.alias" placeholder="ä¾‹å¦‚ï¼šåŠ çƒ­å»¶æ—¶" />
                </div>
                <div class="resource-input-group">
                    <label>é¢„è®¾æ—¶é—´ï¼ˆç§’ï¼‰</label>
                    <input type="number" v-model.number="newTimer.preset" step="0.1" min="0.2" placeholder="1.0" @change="validateTimerPreset('new')" />
                </div>
                <div style="display:flex;gap:12px;margin-top:20px">
                    <button class="btn btn-success" style="flex:1" @click="confirmAddTimer">ç¡®å®š</button>
                    <button class="btn btn-secondary" style="flex:1" @click="showAddTimer = false">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- æ·»åŠ è®¡æ•°å™¨æ¨¡æ€æ¡† -->
        <div v-if="showAddCounter" class="modal" @click.self="showAddCounter = false">
            <div class="modal-content">
                <h2 style="margin-bottom:20px">ğŸ”¢ æ·»åŠ è®¡æ•°å™¨</h2>
                <div class="resource-input-group">
                    <label>è®¡æ•°å™¨åç§°</label>
                    <input v-model="newCounter.name" placeholder="ä¾‹å¦‚ï¼šC0" />
                </div>
                <div class="resource-input-group">
                    <label>åˆ«åï¼ˆå¯é€‰ï¼‰</label>
                    <input v-model="newCounter.alias" placeholder="ä¾‹å¦‚ï¼šäº§å“è®¡æ•°" />
                </div>
                <div class="resource-input-group">
                    <label>é¢„è®¾è®¡æ•°</label>
                    <input type="number" v-model.number="newCounter.preset" min="1" placeholder="10" @change="validateCounterPreset('new')" />
                </div>
                <div style="display:flex;gap:12px;margin-top:20px">
                    <button class="btn btn-success" style="flex:1" @click="confirmAddCounter">ç¡®å®š</button>
                    <button class="btn btn-secondary" style="flex:1" @click="showAddCounter = false">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- é¢„è§ˆæ¢¯å½¢å›¾æ¨¡æ€æ¡† -->
        <div v-if="showPreviewModal" class="modal" @click.self="showPreviewModal = false">
            <div class="modal-content" style="max-width: 90vw; width: 1200px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="font-size: 20px;">æ¢¯å½¢å›¾é¢„è§ˆ</h2>
                    <button class="btn btn-secondary" @click="showPreviewModal = false">å…³é—­</button>
                </div>
                <div style="background: #fdfdfd; border: 1px solid #eee; padding: 20px; overflow: auto;">
                    <canvas ref="ladderCanvas" width="1000" height="600"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    config: { rungs: [], timers: [], counters: [] },
                    showAddTimer: false,
                    showAddCounter: false,
                    newTimer: { name: '', alias: '', preset: 1.0 },
                    newCounter: { name: '', alias: '', preset: 10 },
                    apiBase: window.location.origin,
                    isHelpVisible: false, // å¸®åŠ©è¯´æ˜æŠ˜å æ§åˆ¶
                    showPreviewModal: false // æ¢¯å½¢å›¾é¢„è§ˆæ§åˆ¶
                };
            },
            mounted() {
                this.loadConfigFromServer();
            },
            computed: {
                userMemoryBits() {
                    // M0-M39: ç”¨æˆ·åŒºï¼ˆå¯è¯»å†™ï¼‰ï¼Œå…±40ä¸ª
                    return Array.from({ length: 40 }, (_, i) => `M${i}`);
                },
                yoloMemoryBits() {
                    // M40-M45: YOLOåŒºï¼ˆç³»ç»Ÿå†™å…¥ï¼Œåªè¯»ï¼‰ï¼Œå…±6ä¸ª
                    return Array.from({ length: 6 }, (_, i) => `M${40 + i}`);
                },
                outputMemoryBits() {
                    // æ³¨æ„ï¼šæ ¹æ® MAX_MEMORY=47ï¼Œå®é™…åªæœ‰ M0-M46
                    // ä½† Modbus èµ„æºå±•ç¤ºæ˜¾ç¤º M40-M45 æ˜¯ YOLOï¼ŒM46 å¯èƒ½æ˜¯è¾“å‡ºæ˜ å°„çš„å¼€å§‹
                    // è¿™é‡Œæš‚æ—¶ç•™ç©ºï¼Œå› ä¸º M46 æ˜¯æœ€åä¸€ä¸ªï¼Œå¯èƒ½æ²¡æœ‰å®Œæ•´çš„è¾“å‡ºæ˜ å°„
                    return [];
                }
            },
            methods: {
                // 1. åŸºç¡€é…ç½®åŠ è½½/ä¿å­˜
                async loadConfigFromServer() {
                    try {
                        // ä¸´æ—¶ï¼šè¿”å›å‡çš„é…ç½®æ•°æ®ï¼Œé¿å…åç«¯ API ä¸å­˜åœ¨æ—¶æŠ¥é”™
                        // const response = await axios.get(`${this.apiBase}/api/config`);
                        // this.config = response.data;
                        
                        // ä½¿ç”¨é»˜è®¤ç©ºé…ç½®
                        this.config = { rungs: [], timers: [], counters: [] };
                        console.log('ä½¿ç”¨é»˜è®¤é…ç½®ï¼ˆåç«¯ API æœªå®ç°ï¼‰', this.config);
                    } catch (error) {
                        console.error('åŠ è½½é…ç½®å¤±è´¥', error);
                        // å¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤é…ç½®
                        this.config = { rungs: [], timers: [], counters: [] };
                    }
                },
                async saveConfig() {
                    try {
                        // ä¸´æ—¶ï¼šåç«¯ API æœªå®ç°ï¼Œç›´æ¥æç¤º
                        // await axios.post(`${this.apiBase}/api/config`, this.config);
                        
                        // éªŒè¯é…ç½®æœ‰æ•ˆæ€§
                        let validationError = null;
                        for (const rung of this.config.rungs || []) {
                            for (const cond of rung.conditions || []) {
                                if (cond.type === 'memory' && !this.validateMemoryBit(cond.memory)) {
                                    validationError = `æ¢¯çº§ä¸­çš„æ¡ä»¶åŒ…å«æ— æ•ˆçš„Mä½: ${cond.memory}`;
                                    break;
                                }
                            }
                            if (validationError) break;

                            const action = rung.action || {};
                            if (['memory_set', 'memory_reset'].includes(action.type)) {
                                if (!this.validateMemoryBit(action.memory, true)) {
                                    validationError = `æ¢¯çº§ä¸­çš„åŠ¨ä½œåŒ…å«æ— æ•ˆæˆ–åªè¯»çš„Mä½: ${action.memory}`;
                                    break;
                                }
                            }
                        }

                        if (validationError) {
                            alert(`âŒ é…ç½®éªŒè¯å¤±è´¥: ${validationError}`);
                            return;
                        }

                        // ç”Ÿæˆ JSON å¹¶æç¤ºä¸‹è½½
                        const blob = new Blob([JSON.stringify(this.config, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `plc_config_${new Date().toISOString().slice(0,10)}.json`;
                        a.click();
                        URL.revokeObjectURL(url);
                        
                        alert('âœ… é…ç½®å·²éªŒè¯ï¼æ–‡ä»¶å·²ä¸‹è½½ã€‚è¯·æ‰‹åŠ¨ä¸Šä¼ åˆ° PLC é…ç½®ç›®å½•ã€‚\nï¼ˆåç«¯ API æš‚æœªå®ç°ï¼‰');
                    } catch (error) {
                        alert('âŒ ä¿å­˜å¤±è´¥: ' + error.message);
                    }
                },
                downloadConfig() {
                    const blob = new Blob([JSON.stringify(this.config, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `user_config_${new Date().toISOString().slice(0,10)}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                },
                loadConfig(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const loadedConfig = JSON.parse(e.target.result);
							 if (!loadedConfig || typeof loadedConfig !== 'object' || !Array.isArray(loadedConfig.rungs)) {
								throw new Error("é…ç½®æ–‡ä»¶ç¼ºå°‘æ ¸å¿ƒçš„'rungs'æ•°ç»„ï¼Œæ–‡ä»¶å·²æŸåã€‚");
							}
                            let validationError = null;

                            // --- å¼€å§‹éªŒè¯ ---
                            for (const rung of loadedConfig.rungs || []) {
                                for (const cond of rung.conditions || []) {
                                    if (cond.type === 'memory' && !this.validateMemoryBit(cond.memory)) {
                                        validationError = `æ¢¯çº§ä¸­çš„æ¡ä»¶åŒ…å«æ— æ•ˆçš„Mä½: ${cond.memory}`;
                                        break;
                                    }
                                }
                                if (validationError) break;

                                const action = rung.action || {};
                                if (['memory_set', 'memory_reset'].includes(action.type)) {
                                    if (!this.validateMemoryBit(action.memory, true)) { // æ£€æŸ¥æ˜¯å¦å¯å†™
                                        validationError = `æ¢¯çº§ä¸­çš„åŠ¨ä½œåŒ…å«æ— æ•ˆæˆ–åªè¯»çš„Mä½: ${action.memory}`;
                                        break;
                                    }
                                }
                            }
                            // --- éªŒè¯ç»“æŸ ---

                            if (validationError) {
                                alert(`âŒ é…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥: ${validationError}`);
                                return;
                            }

                            this.config = loadedConfig;
                            alert('âœ… é…ç½®æ–‡ä»¶å·²åŠ è½½å¹¶é€šè¿‡éªŒè¯ï¼è®°å¾—ç‚¹å‡»"ä¿å­˜é…ç½®"ä¸Šä¼ åˆ°æœåŠ¡å™¨ã€‚');

                        } catch (error) {
                            alert('âŒ é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                    event.target.value = '';
                },

                // 2. æ¢¯çº§æ“ä½œ
                addRung() {
                    this.config.rungs.push({
                        id: Date.now(),
                        enabled: true,
                        conditions: [],
                        action: { type: 'output', output: 'Q0' }
                    });
                },
                deleteRung(idx) {
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¢¯çº§å—ï¼Ÿ')) {
                        this.config.rungs.splice(idx, 1);
                    }
                },
                moveRungUp(idx) {
                    if (idx > 0) {
                        [this.config.rungs[idx], this.config.rungs[idx - 1]] = [this.config.rungs[idx - 1], this.config.rungs[idx]];
                    }
                },
                moveRungDown(idx) {
                    if (idx < this.config.rungs.length - 1) {
                        [this.config.rungs[idx], this.config.rungs[idx + 1]] = [this.config.rungs[idx + 1], this.config.rungs[idx]];
                    }
                },

                // 3. æ¡ä»¶æ“ä½œï¼ˆä¿®å¤é€»è¾‘ï¼‰
                addCondition(rung) {
                    rung.conditions.push({
                        type: 'input',
                        input: 'I0',
                        normally_open: true
                    });
                },
                deleteCondition(rung, condIdx) {
                    rung.conditions.splice(condIdx, 1);
                },
                onConditionTypeChange(rung, cond) {
                    // ä¿®å¤ï¼šç›´æ¥ä½¿ç”¨ rung å’Œ cond å¯¹è±¡ï¼Œè€Œä¸æ˜¯ç´¢å¼•
                    const type = cond.type;
                    
                    const newCond = { type };
                    
                    if (type === 'input') { 
                        newCond.input = 'I0'; 
                        newCond.normally_open = true; 
                    } else if (type === 'output') { 
                        newCond.output = 'Q0'; 
                        newCond.normally_open = true; 
                    } else if (type === 'memory') { 
                        newCond.memory = 'M0'; 
                        newCond.normally_open = true; 
                    } else if (type === 'timer') { 
                        newCond.timer = this.config.timers[0]?.name || ''; 
                    } else if (type === 'counter') { 
                        newCond.counter = this.config.counters[0]?.name || ''; 
                    }
                    
                    // ç›´æ¥æ›´æ–° cond å¯¹è±¡çš„å±æ€§
                    Object.assign(cond, newCond);
                },

                // 4. åŠ¨ä½œæ“ä½œï¼ˆä¿®å¤é€»è¾‘ï¼‰
                onActionTypeChange(rung) {
                    // ä¿®å¤ï¼šç›´æ¥ä½¿ç”¨ rung å¯¹è±¡
                    const action = rung.action;
                    const type = action.type;
                    const newAction = { type };

                    if (['output', 'set', 'reset'].includes(type)) { 
                        newAction.output = 'Q0'; 
                    } else if (['memory_set', 'memory_reset'].includes(type)) { 
                        newAction.memory = 'M0'; 
                    } else if (['timer', 'reset_timer'].includes(type)) { 
                        newAction.timer = this.config.timers[0]?.name || ''; 
                    } else if (['counter', 'reset_counter'].includes(type)) { 
                        newAction.counter = this.config.counters[0]?.name || ''; 
                    }
                    
                    // ç›´æ¥æ›´æ–° action å¯¹è±¡çš„å±æ€§
                    Object.assign(action, newAction);
                },
            getActionHelpText(type) {
                const texts = {
                    'output': 'æ¡ä»¶çœŸæ—¶ONï¼Œå‡æ—¶OFF', 'set': 'æ¡ä»¶çœŸæ—¶ç½®ä½ï¼Œéœ€å¤ä½æŒ‡ä»¤æ¸…é™¤', 'reset': 'æ¡ä»¶çœŸæ—¶æ¸…é™¤è¾“å‡º',
                    'memory_set': 'æ¡ä»¶çœŸæ—¶ç½®ä½Mä½', 'memory_reset': 'æ¡ä»¶çœŸæ—¶å¤ä½Mä½', 'timer': 'æ¡ä»¶çœŸæ—¶å¼€å§‹è®¡æ—¶',
                    'reset_timer': 'æ¡ä»¶çœŸæ—¶æ¸…é›¶å®šæ—¶å™¨', 'counter': 'æ¡ä»¶ä¸Šå‡æ²¿è®¡æ•°', 'reset_counter': 'æ¡ä»¶çœŸæ—¶æ¸…é›¶è®¡æ•°å™¨'
                };
                return texts[type] || '';
            },

                // 5. èµ„æºç®¡ç†ï¼ˆæ•´åˆåˆ é™¤é€»è¾‘ï¼Œå¢åŠ æ ¡éªŒï¼‰
                addResource(type, newItem) {
                    if (!newItem.name) {
                        alert(`è¯·è¾“å…¥${type === 'timers' ? 'å®šæ—¶å™¨' : 'è®¡æ•°å™¨'}åç§°`);
                        return false;
                    }
                    if (this.config[type].some(item => item.name === newItem.name)) {
                        alert(`åç§° ${newItem.name} å·²å­˜åœ¨`);
                        return false;
                    }
                    this.config[type].push({ ...newItem });
                    return true;
                },
                confirmAddTimer() {
                    this.validateTimerPreset('new'); // æ–°å¢å‰æ ¡éªŒ
                    if (this.addResource('timers', this.newTimer)) {
                        this.newTimer = { name: `T${this.config.timers.length}`, alias: '', preset: 1.0 };
                        this.showAddTimer = false;
                    }
                },
                confirmAddCounter() {
                    this.validateCounterPreset('new'); // æ–°å¢å‰æ ¡éªŒ
                    if (this.addResource('counters', this.newCounter)) {
                        this.newCounter = { name: `C${this.config.counters.length}`, alias: '', preset: 10 };
                        this.showAddCounter = false;
                    }
                },
                removeResource(type, idx) {
                    const resource = this.config[type][idx];
                    if (confirm(`ç¡®å®šè¦åˆ é™¤ ${resource.name} å—ï¼Ÿ`)) {
                        this.config[type].splice(idx, 1);
                    }
                },

                // 6. èµ„æºå‚æ•°æ ¡éªŒ
                validateTimerPreset(itemOrIndex) {
                    const scanCycle = 0.2; // æ‰«æå‘¨æœŸæœ€å°å€¼
                    const precision = 100; // ç”¨äºä¿®æ­£åˆ°ä¸¤ä½å°æ•° (10^2)
                    let timer = itemOrIndex === 'new' ? this.newTimer : this.config.timers[itemOrIndex];
                    
                    // 1. ç¡®ä¿ preset æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æ•°å­—ï¼Œå¦‚æœä¸æ˜¯åˆ™è®¾ä¸ºé»˜è®¤å€¼1.0
                    let value = parseFloat(timer.preset);
                    if (isNaN(value)) {
                        value = 1.0;
                    }

                    // [æ–°å¢] 2. å°†è¾“å…¥å€¼å¼ºåˆ¶å››èˆäº”å…¥åˆ°ä¸¤ä½å°æ•°
                    //    ä¾‹å¦‚: 2.222222 * 100 = 222.2222 -> Math.round(222.2222) = 222 -> 222 / 100 = 2.22
                    const roundedValue = Math.round(value * precision) / precision;

                    // 3. æ£€æŸ¥æœ€å°å€¼
                    if (roundedValue < scanCycle) {
                        alert(`å®šæ—¶å™¨é¢„è®¾å€¼ä¸èƒ½å°äºä¸€ä¸ªæ‰«æå‘¨æœŸ (${scanCycle}ç§’)ã€‚å·²è‡ªåŠ¨ä¿®æ­£ä¸ºæœ€å°å€¼ã€‚`);
                        timer.preset = scanCycle;
                    } else {
                        // 4. å°†æœ€ç»ˆä¿®æ­£çš„å€¼ï¼ˆå·²å¤„ç†ç²¾åº¦å’Œæœ€å°å€¼ï¼‰èµ‹å›
                        timer.preset = roundedValue;
                    }
                },
                validateCounterPreset(itemOrIndex) {
                    let counter = itemOrIndex === 'new' ? this.newCounter : this.config.counters[itemOrIndex];
                    counter.preset = Math.max(1, Math.floor(counter.preset || 1)); // ç¡®ä¿æ­£æ•´æ•°
                },

                // 7. æ¢¯å½¢å›¾é¢„è§ˆç»˜åˆ¶ï¼ˆä¿ç•™æ—§ä»£ç ä¼˜åŒ–é€»è¾‘ï¼‰
                renderLadderDiagram() {
                    const canvas = this.$refs.ladderCanvas;
                    if (!canvas) {
                        console.error('Canvas å…ƒç´ æœªæ‰¾åˆ°');
                        return;
                    }
                    const config = this.config;
                    if (!config || !config.rungs) {
                        console.error('é…ç½®æ•°æ®æ— æ•ˆ');
                        return;
                    }
                    // åŠ¨æ€è®¡ç®—ç”»å¸ƒé«˜åº¦
                    const RUNG_HEIGHT = 80;
                    const PADDING = 60;
                    const requiredHeight = (config.rungs.length || 1) * RUNG_HEIGHT + PADDING;
                    canvas.height = requiredHeight;
                    const ctx = canvas.getContext('2d');
                    if (!ctx) {
                        console.error('æ— æ³•è·å– Canvas ä¸Šä¸‹æ–‡');
                        return;
                    }

                    // ç»˜å›¾å¸¸é‡
                    const START_X = 50;
                    const SYMBOL_WIDTH = 60;
                    const SYMBOL_SPACING = 40;
                    const RAIL_WIDTH = canvas.width - 100;
                    const RAIL_Y_START = 30;

                    // æ¸…ç©ºç”»å¸ƒ
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    // ç»˜åˆ¶ç”µæºè½¨
                    ctx.fillStyle = '#333';
                    ctx.fillRect(START_X, RAIL_Y_START, 4, requiredHeight - PADDING); // å·¦ä¾§
                    ctx.fillRect(START_X + RAIL_WIDTH, RAIL_Y_START, 4, requiredHeight - PADDING); // å³ä¾§

                    // ç»˜åˆ¶æ¯ä¸ªæ¢¯çº§
                    config.rungs.forEach((rung, index) => {
                        const y = RAIL_Y_START + (index * RUNG_HEIGHT) + (RUNG_HEIGHT / 2);
                        // ç»˜åˆ¶æ°´å¹³çº¿
                        ctx.strokeStyle = '#333';
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.moveTo(START_X, y);
                        ctx.lineTo(START_X + RAIL_WIDTH, y);
                        ctx.stroke();

                        let currentX = START_X + SYMBOL_SPACING;
                        // ç»˜åˆ¶æ¡ä»¶
                        rung.conditions.forEach(cond => {
                            this.drawCondition(ctx, currentX, y, cond);
                            currentX += SYMBOL_WIDTH + SYMBOL_SPACING;
                        });
                        // ç»˜åˆ¶åŠ¨ä½œ
                        this.drawAction(ctx, START_X + RAIL_WIDTH - SYMBOL_WIDTH - SYMBOL_SPACING, y, rung.action);
                    });
                },
                drawCondition(ctx, x, y, cond) {
                    let label = '';
                    
                    if (cond.type === 'input' && cond.input) {
                        label = cond.input;
                        this.drawContact(ctx, x, y, cond.normally_open);
                    } else if (cond.type === 'output' && cond.output) {
                        label = cond.output;
                        this.drawContact(ctx, x, y, cond.normally_open);
                    } else if (cond.type === 'memory' && cond.memory) { // <--- æ–°å¢å¯¹Mä½çš„å¤„ç†
                        label = cond.memory;
                        this.drawContact(ctx, x, y, cond.normally_open);
                    } else if (cond.type === 'timer' && cond.timer) {
                        label = `${cond.timer}.DN`;
                        this.drawContact(ctx, x, y, true);
                    } else if (cond.type === 'counter' && cond.counter) {
                        label = `${cond.counter}.DN`;
                        this.drawContact(ctx, x, y, true);
                    }

                    if (label) {
                        ctx.fillStyle = '#005a9e';
                        ctx.font = 'bold 13px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(label, x + 30, y - 20);
                    }
                },
                drawAction(ctx, x, y, action) {
                    let label = '';
                    let coilText = '';

                    if (['output', 'set', 'reset'].includes(action.type) && action.output) {
                        label = action.output;
                        if (action.type === 'set') coilText = 'S';
                        if (action.type === 'reset') coilText = 'R';
                    } else if (['memory_set', 'memory_reset'].includes(action.type) && action.memory) { // <--- æ–°å¢å¯¹Mä½çš„å¤„ç†
                        label = action.memory;
                        if (action.type === 'memory_set') coilText = 'S';
                        if (action.type === 'memory_reset') coilText = 'R';
                    } else if (['timer', 'reset_timer'].includes(action.type) && action.timer) {
                        label = action.timer;
                        coilText = action.type === 'reset_timer' ? 'RST' : 'TON';
                    } else if (['counter', 'reset_counter'].includes(action.type) && action.counter) {
                        label = action.counter;
                        coilText = action.type === 'reset_counter' ? 'RST' : 'CTU';
                    }

                    this.drawCoil(ctx, x, y, coilText); // ç»˜åˆ¶çº¿åœˆ

                    if (label) {
                        ctx.fillStyle = '#005a9e';
                        ctx.font = 'bold 13px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(label, x + 30, y - 20);
                    }
                },
                drawContact(ctx, x, y, isNormallyOpen) {
                    const h = 20;
                    ctx.strokeStyle = '#333';
                    ctx.lineWidth = 2;
                    // è§¦ç‚¹åŸºç¡€å›¾å½¢
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                    ctx.lineTo(x + 15, y);
                    ctx.moveTo(x + 15, y - h / 2);
                    ctx.lineTo(x + 15, y + h / 2);
                    ctx.moveTo(x + 45, y - h / 2);
                    ctx.lineTo(x + 45, y + h / 2);
                    ctx.moveTo(x + 45, y);
                    ctx.lineTo(x + 60, y);
                    ctx.stroke();
                    // å¸¸é—­è§¦ç‚¹æ·»åŠ æ–œçº¿
                    if (!isNormallyOpen) {
                        ctx.beginPath();
                        ctx.moveTo(x + 17, y + h / 2 - 2);
                        ctx.lineTo(x + 43, y - h / 2 + 2);
                        ctx.stroke();
                    }
                },
                drawCoil(ctx, x, y, text = '') {
                    const r = 12;
                    ctx.strokeStyle = '#333';
                    ctx.lineWidth = 2;
                    // çº¿åœˆå›¾å½¢
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                    ctx.lineTo(x + 5, y);
                    ctx.arc(x + 5 + r, y, r, Math.PI, 0);
                    ctx.moveTo(x + 5 + 2 * r, y);
                    ctx.lineTo(x + 60, y);
                    ctx.stroke();
                    // çº¿åœˆæ–‡æœ¬
                    if (text) {
                        ctx.font = 'bold 12px Arial';
                        ctx.fillStyle = '#333';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(text, x + 30, y);
                    }
                },    
                validateMemoryBit(bit, isWritable = false) {
                    if (typeof bit !== 'string' || !bit.startsWith('M')) return false;
                    const num = parseInt(bit.substring(1));
                    if (isNaN(num)) return false;

                    // æ£€æŸ¥æ€»èŒƒå›´ï¼šM0-M46ï¼ˆå…±47ä¸ªï¼‰
                    if (num < 0 || num > 46) return false;

                    // å¦‚æœè¦æ±‚æ˜¯å¯å†™çš„ï¼Œåˆ™åªèƒ½å†™å…¥ç”¨æˆ·åŒº M0-M39
                    if (isWritable && num > 39) return false;

                    return true;
                },
            },
            watch: {
                // ç›‘å¬æ¨¡æ€æ¡†æ˜¾ç¤ºï¼Œè‡ªåŠ¨å¡«å……èµ„æºåç§°
                showAddTimer(val) {
                    if (val) this.newTimer.name = `T${this.config.timers.length}`;
                },
                showAddCounter(val) {
                    if (val) this.newCounter.name = `C${this.config.counters.length}`;
                },
                // ç›‘å¬é¢„è§ˆæ¨¡æ€æ¡†ï¼Œæ¸²æŸ“æ¢¯å½¢å›¾
                showPreviewModal(isShowing) {
                    if (isShowing) this.$nextTick(() => this.renderLadderDiagram());
                }
            }
        }).mount('#app');
    </script>
</body>
</html>