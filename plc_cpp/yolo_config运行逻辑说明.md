# yolo_config.json 运行逻辑说明

## 配置文件概述

`plc_config.json` 定义了基于 YOLO 疲劳检测等级的 PLC 控制逻辑，通过中间继电器（M40-M42）接收 YOLO 检测结果，控制不同的输出（Q0-Q5）和定时器。

## 定时器配置

| 定时器 | 预设值 | 别名 | 用途 |
|--------|--------|------|------|
| **T1** | 0.5秒 | Q0_Blink_1s | 控制 Q0 闪烁（周期 1 秒：0.5秒开 + 0.5秒关） |
| **T4** | 0.3秒 | Q4_LED_Blink | 控制 Q4 闪烁（周期 0.6秒：0.3秒开 + 0.3秒关） |

## 梯形图逻辑（Rungs）详解

### 1. YOLO Level 1 控制逻辑

#### Rung: `YOLO_Level1_Q3_output`
```json
条件: M40 (常开触点)
动作: 输出 Q3
```

**运行逻辑**：
- 当 YOLO 检测到 **Level 1** 疲劳等级时，上位机通过 Modbus 写入 **M40 = 1**
- M40 为真时，**Q3 输出高电平**
- M40 为假时，Q3 输出低电平

**应用场景**：Level 1 疲劳时，Q3 输出（震动马达）

---

### 2. YOLO Level 2 控制逻辑（带定时器闪烁）

#### Rung: `YOLO_Level2_T4_enable`
```json
条件: M41 (常开) AND T4 (常闭，即未到时)
动作: 使能定时器 T4
```

**运行逻辑**：
- 当 YOLO 检测到 **Level 2** 疲劳等级时，上位机写入 **M41 = 1**
- M41 为真 **且** T4 未到时，使能定时器 T4
- T4 开始计时，0.3秒后到时

#### Rung: `YOLO_Level2_Q4_output`
```json
条件: T4 (常开，即已到时)
动作: 输出 Q4
```

**运行逻辑**：
- T4 定时器到时后，**Q4 输出高电平**
- 由于 T4 是自循环的（通过 `YOLO_Level2_T4_enable`），Q4 会以 0.6秒周期闪烁

**完整流程**：
1. M41 = 1 → 使能 T4
2. T4 计时 0.3秒 → T4 到时 → Q4 = 1
3. T4 到时后，`YOLO_Level2_T4_enable` 条件不满足（T4 常闭断开）
4. T4 复位 → Q4 = 0
5. 循环重复步骤 1-4

**应用场景**：Level 2 疲劳时，Q4 快速闪烁（0.6秒周期），提醒更紧急，用于进行光提醒

---

### 3. YOLO Level 3 控制逻辑

#### Rung: `YOLO_Level3_Q5_output`
```json
条件: M42 (常开触点)
动作: 输出 Q5
```

**运行逻辑**：
- 当 YOLO 检测到 **Level 3** 疲劳等级时，上位机写入 **M42 = 1**
- M42 为真时，**Q5 输出高电平**（常亮）
- M42 为假时，Q5 输出低电平

**应用场景**：Level 3 严重疲劳时，Q5 常亮（蜂鸣器常开）

---

### 4. Q0 自循环闪烁逻辑（测试/备用）

#### Rung: `timer_T1_enable_Q0`
```json
条件: T1 (常闭，即未到时)
动作: 使能定时器 T1
```

**运行逻辑**：

- T1 未到时，使能 T1（自循环）
- T1 开始计时，0.5秒后到时

#### Rung: `output_Q0_from_T1`
```json
条件: T1 (常开，即已到时)
动作: 输出 Q0
```

**运行逻辑**：
- T1 定时器到时后，**Q0 输出高电平**
- 由于 T1 是自循环的，Q0 会以 1秒周期闪烁（0.5秒开 + 0.5秒关）

**应用场景**：Q0 持续闪烁，可用于系统运行指示或测试

---

## 内存继电器映射

根据代码定义（`plc_types.h`）：
- **M40** = YOLO Level 1 标志位（Y1）
- **M41** = YOLO Level 2 标志位（Y2）
- **M42** = YOLO Level 3 标志位（Y3）
- **M43-M45** = YOLO Level 4-6 标志位（Y4-Y6，未在此配置中使用）

## 输出引脚映射

根据 `plc_runtime.h` 定义：
- **Q0** = GPIO 35
- **Q1** = GPIO 46
- **Q2** = GPIO 37
- **Q3** = GPIO 71
- **Q4** = GPIO 72
- **Q5** = GPIO 73

## 运行流程图

```
┌─────────────────────────────────────────────────────────┐
│                    YOLO 检测系统                        │
│  (通过 Modbus 写入 M40/M41/M42)                         │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│              PLC 扫描周期（20ms）                       │
│                                                         │
│  1. 读取输入状态（I0-I2）                               │
│  2. 读取中间继电器（M40-M42）                           │
│  3. 执行梯形图逻辑                                      │
│     ├─ M40=1 → Q3=1 (Level 1)                          │
│     ├─ M41=1 → 使能 T4 → Q4 闪烁 (Level 2)              │
│     └─ M42=1 → Q5=1 (Level 3)                           │
│  4. 更新定时器状态                                      │
│  5. 写入输出（Q0-Q5）                                   │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│                   硬件输出                              │
│  Q0: 1秒周期闪烁（测试）                                │
│  Q3: Level 1 时高电平                                   │
│  Q4: Level 2 时 0.6秒周期闪烁                           │
│  Q5: Level 3 时常亮                                     │
└─────────────────────────────────────────────────────────┘
```

## 典型运行场景

### 场景 1：正常状态
- M40 = 0, M41 = 0, M42 = 0
- Q0 持续闪烁（1秒周期）
- Q3 = 0, Q4 = 0, Q5 = 0

### 场景 2：Level 1 疲劳
- M40 = 1（上位机写入）
- Q0 持续闪烁
- **Q3 = 1**（高电平，提示 Level 1）
- Q4 = 0, Q5 = 0

### 场景 3：Level 2 疲劳
- M41 = 1（上位机写入）
- Q0 持续闪烁
- Q3 = 0
- **Q4 快速闪烁**（0.6秒周期，更紧急的提示）
- Q5 = 0

### 场景 4：Level 3 严重疲劳
- M42 = 1（上位机写入）
- Q0 持续闪烁
- Q3 = 0, Q4 = 0
- **Q5 = 1**（常亮，最高级别警报）

### 场景 5：多等级同时触发（理论上不应该发生）
- 如果 M40、M41、M42 同时为 1
- Q3、Q4、Q5 都会输出
- 实际应用中应该互斥

## 注意事项

1. **定时器自循环**：T1 和 T4 通过"常闭触点"实现自循环，确保持续闪烁
2. **扫描周期**：PLC 每 20ms 扫描一次，所有逻辑在扫描周期内执行
3. **Modbus 写入**：上位机通过 Modbus TCP 写入 M40-M42，PLC 实时响应
4. **优先级**：Level 3 > Level 2 > Level 1，但配置中未实现互斥逻辑
5. **Q0 测试输出**：Q0 持续闪烁，可用于系统运行状态指示

## 修改建议

如果需要实现等级互斥（高等级覆盖低等级），可以修改逻辑：
- Level 3 时：M42=1 → Q5=1，同时 Q3=0, Q4=0
- Level 2 时：M41=1 → Q4闪烁，同时 Q3=0, Q5=0
- Level 1 时：M40=1 → Q3=1，同时 Q4=0, Q5=0



