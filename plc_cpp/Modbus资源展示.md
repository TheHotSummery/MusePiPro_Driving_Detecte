# Modbus 资源概览

## 服务信息
- 默认监听地址：`0.0.0.0`
- 默认端口：`502`（需要 root 或赋予二进制 `cap_net_bind_service` 权限）
- Modbus 从站 ID：`1`

若端口 502 无法绑定，可运行：
```bash
sudo setcap 'cap_net_bind_service=+ep' ./build/plc_core
```
或在代码中把监听端口改为大于 1024 的值。

## 线圈（Coils, 功能码 0x01 / 0x05）
| 1-based 地址 | 0-based 地址 | PLC 对象 | 说明 |
|--------------|--------------|----------|------|
| 00001-00006  | 0-5          | Q0-Q5    | 六路物理输出；写入后立即驱动 GPIO 35/46/37/71/72/73 |
| 00007-00046  | 6-45         | M0-M39   | 通用中间继电器；支持读写 |
| 00047-00052  | 46-51        | M40-M45  | YOLO 状态位（对应 `Y1-Y6`）；读写均可 |
| 00053-00058  | 52-57        | M46-M51  | 输出状态镜像，只读；任何写入都会被立即回写成真实输出状态 |

## 离散量输入（Discrete Inputs, 功能码 0x02）
| 1-based 地址 | 0-based 地址 | PLC 对象 | 硬件 GPIO |
|--------------|--------------|----------|-----------|
| 10001        | 0            | I0       | GPIO 74   |
| 10002        | 1            | I1       | GPIO 91   |
| 10003        | 2            | I2       | GPIO 92   |

## 保持寄存器（Holding Registers, 功能码 0x03 / 0x06）
| 1-based 地址 | 说明 |
|--------------|------|
| 40001        | `scan_counter` 低 16 位（扫描次数） |
| 40002        | `scan_counter` 高 16 位 |
| 40003        | `scan_time_ms`（上一次扫描周期，毫秒） |
| 40004        | `error_code`（0=正常） |
| 40005        | `heartbeat`（心跳计数，每秒加 1） |
| 40006        | `emergency_stop` 标志（1 表示触发） |
| 40007-40032  | 预留（当前读取为 0） |

## 输入寄存器（Input Registers, 功能码 0x04）
- 地址 30001-30032 预留，当前返回 0。

## 使用示例
- 查看输出状态：读取线圈 `00001-00006`。
- 控制 Q5：写线圈 `00007`（`0`=关闭 `M0`，`1`=开启 `M0`）。
- 查看设备运行状况：读取保持寄存器 `40001-40006`，可观察扫描次数与心跳是否递增。
- 高速轮询建议修改设置超时 ≥ 500 ms，并在心跳停止递增时采取故障处理措施。

---
如需调整映射范围，可修改 `PLCConstants` 中的最大数量或在 `PLCRuntime::update_modbus_mapping` 中扩展映射逻辑。
