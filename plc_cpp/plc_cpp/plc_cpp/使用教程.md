# PLC C++ 核心控制器 v3.0 - 使用教程

本文档旨在指导用户如何在 Spacemit Muse Pi Pro (RISC-V) 板上编译、配置和运行 C++ 版本的 PLC 核心控制器。

## 📋 环境要求

- **硬件**: Spacemit Muse Pi Pro 开发板
- **操作系统**: Debian / Ubuntu (Linux)
- **依赖库**:
  - `build-essential` (包含 g++, make 等)
  - `cmake` (版本 >= 3.10)
  - `libgpiod-dev` (GPIO 控制)
  - `pkg-config`

## 🚀 快速开始

### 1. 首次部署与编译

#### a. 上传代码
将 `plc_cpp` 文件夹上传到开发板的 `/home/hyit/` 目录下。

#### b. 安装依赖
通过 SSH 连接到开发板，然后执行以下命令安装必要的软件包：
```bash
sudo apt-get update
sudo apt-get install -y build-essential cmake libgpiod-dev pkg-config
```

#### c. 编译
进入 `plc_cpp` 目录并执行构建脚本：
```bash
cd /home/hyit/plc_cpp
chmod +x build.sh
./build.sh
```
编译成功后，可执行文件将位于 `./build/plc_core`。

### 2. 配置PLC

新版控制器使用单一配置文件 `plc_config.json`，集中管理所有梯级、定时器和计数器。

#### a. 创建配置目录和文件
```bash
# 执行配置脚本
chmod +x setup_config.sh
./setup_config.sh
```
此脚本将创建 `/home/hyit/plc_core` 目录，并将 `config/` 目录下的模板配置文件 `plc_config.json` 复制到该位置。

#### b. `plc_config.json` 详解
默认配置实现了3个灯以不同频率闪烁（亮0.5秒，灭0.5-1.5秒不等）。
```json
{
  "rungs": [
    // ... 梯级逻辑 ...
  ],
  "timers": [
    // ... 定时器定义 ...
  ],
  "counters": []
}
```
- **rungs**: 定义梯级逻辑。每个梯级包含触发 `conditions` (条件) 和一个 `action` (动作)。
- **timers**: 定义定时器。`preset` 单位为秒。
- **counters**: 定义计数器。

### 3. 运行与停止

**必须使用 `sudo` 权限运行，因为它需要访问 GPIO。**

#### a. 前台运行 (用于调试)
```bash
sudo ./build/plc_core
```
按 `Ctrl+C` 可以优雅地停止程序。

#### b. 后台守护进程模式运行 (用于生产)
```bash
sudo ./build/plc_core -d
```
程序将作为守护进程在后台持续运行。

#### c. 查看运行状态
```bash
ps aux | grep plc_core
```
如果看到进程正在运行，说明启动成功。

#### d. 停止后台进程
推荐使用 `SIGTERM` (信号15) 来优雅关闭：
```bash
# 查找进程ID (PID)
pgrep -f plc_core

# 停止进程 (将 <PID> 替换为实际的进程号)
sudo kill -TERM <PID>
```
如果程序无法正常停止，可使用 `kill -9` 强制终止。

## ⚙️ 进阶功能

### 1. 热重载配置

程序运行时，可以修改 `/home/hyit/plc_core/plc_config.json` 文件。程序会自动检测文件变化并在1-2秒内重新加载新的逻辑，无需重启。

**操作步骤**:
1. 让 `plc_core` 在前台或后台运行。
2. 使用 `nano` 或其他编辑器修改并保存 `/home/hyit/plc_core/plc_config.json`。
3. 观察程序输出或设备状态，新的逻辑会立即生效。

### 2. 命令行选项
```
用法: ./build/plc_core [选项]
选项:
  -h, --help     显示帮助信息
  -c, --config   指定 plc_config.json 的完整路径
  -d, --daemon   以守护进程模式运行
  -v, --version  显示版本信息
```
示例：使用自定义位置的配置文件
```bash
sudo ./build/plc_core -c /home/hyit/my_special_config.json
```

## 🔍 故障排查

#### 问题 1: 编译失败，提示找不到 `libgpiod`。
- **原因**: 依赖库未安装或 `pkg-config` 未找到。
- **解决**: 确保已执行 `sudo apt-get install -y libgpiod-dev pkg-config`。

#### 问题 2: 运行后灯不亮，或行为不符合预期。
- **原因 1**: `plc_config.json` 语法错误或逻辑不正确。
- **解决 1**: 仔细检查JSON文件格式。可以使用在线JSON校验工具。
- **原因 2**: GPIO引脚号不正确或被占用。
- **解决 2**: 检查 `plc_runtime.h` 中定义的 `OUTPUT_PINS` 是否与硬件连接一致。

#### 问题 3: 程序无法启动，提示 "权限不足" 或 "GPIO初始化失败"。
- **原因**:未使用 `sudo` 权限运行，或当前用户不在 `gpio` 用户组中。
- **解决**:
  1. 总是使用 `sudo ./build/plc_core` 启动。
  2. （可选）将用户添加到 `gpio` 组: `sudo usermod -aG gpio $USER`，然后重新登录。

## 🏗️ 代码结构概览

- `main.cpp`: 程序入口，处理命令行参数、信号和主流程。
- `plc_runtime.cpp`: PLC核心运行时，管理主循环、线程和状态。
- `ladder_engine.cpp`: 梯形图逻辑执行引擎，负责处理所有`rungs`。
- `json_parser.cpp`: 一个简单的、手写的JSON解析器，用于读取配置文件。
- `gpio_driver.cpp`: `libgpiod` 的封装，提供GPIO读写功能。
- `shared_memory.cpp`: 共享内存管理器，用于与其他进程（如Python）通信。
- `watchdog.cpp`: 看门狗，确保主循环未卡死。
- `include/`: 包含所有对应的头文件。
- `config/`: 包含配置文件的模板。
- `scripts/`: 包含构建、设置、运行和停止的辅助脚本。


