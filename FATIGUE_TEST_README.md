# 疲劳状态测试功能说明

## 功能概述

新增了疲劳状态测试功能，允许在调试阶段手动设置疲劳分数和疲劳行为，**完全模拟真实的疲劳检测流程**，包括分数自动回退、GPIO触发、事件记录和网络上报等功能。

## 新增功能

### 1. 前端疲劳测试面板

位置：右侧控制面板中的"疲劳状态测试"卡片

功能：
- **测试模式开关**：启用/禁用测试模式
- **疲劳分数设置**：通过滑块或快速按钮设置疲劳分数（0-100）
- **疲劳行为设置**：选择要模拟的疲劳行为类型
- **测试操作**：应用设置、重置设置、模拟疲劳事件
- **当前状态显示**：实时显示当前疲劳等级和状态

### 2. 后端API接口

#### 设置测试疲劳状态
```
POST /test/fatigue_state
Content-Type: application/json

{
  "score": 75,
  "behaviors": ["eyes_closed", "yarning"],
  "is_test_mode": true
}
```

#### 重置测试疲劳状态
```
POST /test/reset_fatigue_state
```

#### 模拟疲劳事件
```
POST /test/simulate_fatigue_event
Content-Type: application/json

{
  "behavior": "eyes_closed",
  "confidence": 0.85,
  "duration": 3.0,
  "score": 75
}
```

### 3. 视频流和帧率修复

- 修复了视频流连接问题
- 添加了实时FPS计算和显示
- 改进了视频流错误处理和重连机制

## 核心特性

### ✅ 完全兼容正常检测逻辑
- **分数自动回退**：长时间无行为时自动降低分数
- **专注驾驶检测**：检测到专注驾驶时快速回退分数
- **GPIO正常触发**：根据等级自动触发相应的GPIO警报
- **事件正常记录**：所有事件都会记录到CSV文件
- **网络上报正常**：支持GPS和事件数据上报
- **模块初始化检查**：确保所有模块准备就绪后才执行操作

### ✅ 真实的疲劳检测流程
- **行为权重计算**：根据配置的权重计算分数增量
- **持续时间影响**：行为持续时间影响分数累积
- **等级自动切换**：根据分数自动切换疲劳等级
- **事件合并逻辑**：相同行为的事件会自动合并
- **分心计数更新**：正常更新分心驾驶次数

## 使用方法

### 1. 启用测试模式

1. 在前端界面找到"疲劳状态测试"面板
2. 打开"启用测试模式"开关
3. 面板会展开显示测试控制选项

### 2. 设置疲劳分数

- 使用滑块调整分数（0-100）
- 或点击快速按钮：正常(0)、一级(50)、二级(75)、三级(95)

### 3. 选择疲劳行为

勾选要模拟的疲劳行为：
- 闭眼 (eyes_closed)
- 打哈欠 (yarning)
- 闭眼左倾 (eyes_closed_head_left)
- 闭眼右倾 (eyes_closed_head_right)
- 低头 (head_down)
- 左看 (seeing_left)
- 右看 (seeing_right)
- 抬头 (head_up)

### 4. 应用测试设置

点击"应用测试设置"按钮，系统会：
- 设置指定的疲劳分数和等级
- 开始模拟真实的检测流程
- 根据行为权重和时间自动调整分数
- 触发相应的GPIO警报

### 5. 模拟疲劳事件

点击"模拟疲劳事件"按钮，系统会：
- 更新当前活跃的测试行为
- 根据行为权重增加分数
- 创建相应的事件记录
- 触发GPIO警报（如果达到阈值）
- 保存事件到CSV文件

### 6. 观察自动回退

系统会自动：
- **分数回退**：长时间无行为时分数逐渐降低
- **等级切换**：分数变化时自动切换疲劳等级
- **事件记录**：所有状态变化都会记录
- **GPIO控制**：等级变化时触发相应警报

### 7. 重置设置

点击"重置设置"按钮，系统会：
- 清除所有测试数据
- 重置疲劳分数为0
- 清空事件记录
- 恢复正常检测模式

## 测试场景

### 场景1：测试分数自动回退
1. 设置分数为75（二级警报）
2. 选择"闭眼"行为
3. 应用设置，观察GPIO触发
4. 等待5-10秒，观察分数自动回退
5. 验证等级从二级降为一级或正常

### 场景2：测试GPIO触发
1. 设置分数为95（三级警报）
2. 选择多种疲劳行为
3. 应用设置
4. 观察GPIO是否触发三级警报
5. 检查事件记录中的警报事件

### 场景3：测试事件记录和上报
1. 启用测试模式
2. 设置分数为75
3. 点击"模拟疲劳事件"
4. 检查事件记录中是否出现新事件
5. 检查CSV文件是否保存了事件数据
6. 验证网络上报功能是否正常

### 场景4：测试专注驾驶检测
1. 设置分数为50
2. 应用设置
3. 等待一段时间（模拟专注驾驶）
4. 观察分数是否快速回退
5. 验证等级是否降为正常

### 场景5：测试行为权重影响
1. 设置分数为0
2. 选择不同权重的行为（如"闭眼"vs"低头"）
3. 点击"模拟疲劳事件"
4. 观察不同行为对分数的影响
5. 验证权重配置是否正确应用

## 注意事项

1. **测试模式**：启用测试模式后，系统会停止正常的YOLO检测，但保持所有其他逻辑
2. **完全兼容**：测试模式与正常检测模式完全兼容，所有功能正常工作
3. **数据持久化**：所有事件都会保存到CSV文件中，包括测试事件
4. **状态同步**：测试设置会实时同步到前端显示，包括疲劳等级和状态
5. **自动回退**：分数会根据时间自动回退，模拟真实的驾驶场景
6. **GPIO触发**：所有GPIO警报功能在测试模式下正常工作
7. **网络上报**：测试数据可以通过现有的网络上报功能发送到服务器
8. **模块检查**：系统会检查所有模块是否初始化完成，确保功能正常

## 故障排除

### 视频流显示"连接中..."
1. 检查后端服务是否正常运行
2. 检查摄像头设备是否可用
3. 尝试点击"重连"按钮
4. 检查网络连接

### 帧率显示0.0
1. 确保视频流正常连接
2. 检查后端日志是否有错误
3. 重启后端服务

### API接口调用失败
1. 检查后端服务是否运行在正确端口
2. 检查网络连接
3. 查看后端日志错误信息

## 技术实现

### 前端
- Vue 3 + Element Plus
- 响应式状态管理
- 实时数据更新

### 后端
- Flask + SocketIO
- 行为分析器扩展
- 测试模式支持
- 实时FPS计算

### 数据流
1. 前端发送测试请求
2. 后端更新行为分析器状态
3. 通过SocketIO实时推送更新
4. 前端接收并显示最新状态
